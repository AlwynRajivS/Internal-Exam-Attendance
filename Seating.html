<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exam Seating — Constraint-aware Multi-Hall</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg1:#e6f9ff; --bg2:#f7f5ff;
  --card:#fff;
  --muted:#6b7a86;
  --i-color:#007bff;   /* I */
  --ii-color:#28a745;  /* II */
  --iii-color:#fd7e14; /* III */
  --iv-color:#dc3545;  /* IV */
  --empty:#f1f5f9;
  --shadow: 0 10px 30px rgba(10,30,40,0.06);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:Inter, Poppins, system-ui, Arial; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#052029; padding:16px;}
.wrap{max-width:1200px;margin:0 auto;}
header{display:flex;align-items:center;gap:14px;margin-bottom:12px;flex-wrap:wrap}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
h1{font-size:20px;margin:0}
.lead{font-size:13px;color:#0b5564}
.main{display:grid;grid-template-columns:420px 1fr;gap:16px}
.card{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
label{display:block;font-size:13px;color:#073741;margin-top:8px}
input[type=text],input[type=number],input[type=date],select,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(3,37,45,0.06);font-size:14px}
.controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:#021;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(3,37,45,0.06);color:#073741}
.small{font-size:12px;color:var(--muted)}
.hall-list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
.hall-item{display:grid;grid-template-columns:1fr 56px 56px 44px 44px 44px 44px 36px;gap:6px;align-items:center}
.hall-item input{padding:8px}
.preview{min-height:280px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbf7ff)}
.legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.legend-item{display:flex;gap:6px;align-items:center}
.legend-swatch{width:18px;height:18px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)}
.preview-halls{display:flex;flex-direction:column;gap:12px}
.hall-preview{border-radius:10px;padding:10px;border:1px solid rgba(3,37,45,0.03);background:linear-gradient(180deg,#fff,#fcfdff)}
.hall-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.seat-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.row-label{width:28px;text-align:center;color:var(--muted);font-weight:600}
.seat{min-width:54px;height:46px;border-radius:8px;background:var(--empty);border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:12px;position:relative;cursor:pointer;transition:0.12s}
.seat.empty{opacity:0.36}
.seat:hover{transform:translateY(-4px)}
.tooltip{position:absolute;background:#021;color:#fff;font-size:11px;padding:6px 8px;border-radius:6px;top:-44px;left:50%;transform:translateX(-50%);opacity:0;pointer-events:none;transition:0.12s}
.seat:hover .tooltip{opacity:1}
.counter{margin-top:8px;font-size:13px;color:#052029}
.student-list{max-height:260px;overflow:auto;border-radius:8px;border:1px solid #eef4f7;padding:8px;background:#fff;margin-top:10px}
.student-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:6px;border:1px dashed transparent}
.student-row:hover{background:#fbfeff;border-color:#e6f4fb}
.student-row.selected{outline:3px solid rgba(6,182,212,0.12)}
@media (max-width:980px){.main{grid-template-columns:1fr}.hall-item{grid-template-columns:1fr 44px 44px 34px 34px 34px 34px 30px}.seat{min-width:44px;height:36px;font-size:11px}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">ES</div>
    <div>
      <h1>Exam Seating — Constraint-aware</h1>
      <div class="lead">Avoid same-year or same-subject adjacent (left/right). Preview, manual adjust and export Excel.</div>
    </div>
  </header>

  <div class="main">
    <!-- LEFT: Controls -->
    <div>
      <div class="card">
        <label>Date</label>
        <input type="date" id="inpDate">

        <label>Department</label>
        <input type="text" id="inpDept" placeholder="CSE / ECE ...">

        <label>Batch</label>
        <input type="text" id="inpBatch" placeholder="FN / AN">

        <label style="margin-top:8px">Upload students (.xlsx/.csv)</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <div class="small">Required columns: Roll No, Name, Year, Section, Subject Code, Subject Name</div>
        <div class="counter" id="counterInfo">Total: 0 | Assigned: 0 | Unassigned: 0</div>

        <div class="controls" style="margin-top:8px">
          <button class="btn" id="btnTemplate">Download Template</button>
          <button class="btn ghost" id="btnLoadSample">Load Sample</button>
        </div>

        <hr style="margin:10px 0">

        <label>Halls (add/remove and set rows/cols)</label>
        <div class="hall-list" id="hallList"></div>
        <div class="controls" style="margin-top:8px">
          <button class="btn ghost" id="btnAddHall">+ Add Hall</button>
          <button class="btn" id="btnRemoveLast">Remove Last</button>
        </div>

        <label style="margin-top:10px">Seating pattern</label>
        <select id="pattern">
          <option value="row">Row-wise</option>
          <option value="col">Column-wise</option>
          <option value="snake">Snake</option>
          <option value="alternate">Alternate rows</option>
        </select>

        <label style="margin-top:8px"><input type="checkbox" id="randomize" checked> Randomize pool per attempt</label>

        <div class="controls" style="margin-top:10px">
          <button class="btn" id="btnPreview">Preview Layout</button>
          <button class="btn ghost" id="btnFinalize">Generate & Export Excel</button>
        </div>

        <div class="small" style="margin-top:8px">Algorithm will attempt many randomized arrangements to avoid left/right conflicts (same year or same subject code). If perfect seating impossible it selects arrangement with minimal conflicts.</div>
      </div>
    </div>

    <!-- RIGHT: Preview + Student list -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div id="messages"><strong>No file loaded.</strong></div>
            <div class="legend">
              <div class="legend-item"><div class="legend-swatch" style="background:var(--i-color)"></div>I</div>
              <div class="legend-item"><div class="legend-swatch" style="background:var(--ii-color)"></div>II</div>
              <div class="legend-item"><div class="legend-swatch" style="background:var(--iii-color)"></div>III</div>
              <div class="legend-item"><div class="legend-swatch" style="background:var(--iv-color)"></div>IV</div>
            </div>
          </div>
          <div class="small">Click student → click seat to assign manually</div>
        </div>

        <div id="preview" class="preview">
          <div class="small">Preview will appear here after clicking <strong>Preview Layout</strong>.</div>
        </div>

        <div style="margin-top:10px">
          <strong>Unassigned Students (preview)</strong>
          <input id="searchStudent" placeholder="Search roll/name/subject" style="margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(3,37,45,0.06)">
          <div class="student-list" id="studentList"></div>
        </div>
      </div>
    </div>
  </div>

  <footer style="text-align:center;margin-top:14px;color:#6a7d86">Export header uses: Date, Department, Batch, Hall No, Student Roll No, Name, Seating No, Subject Code, Subject, Year, Section</footer>
</div>

<script>
/* ====== state ====== */
let students = [];            // parsed original student list
let previewPool = [];         // pool used for preview
let previewUnassigned = [];   // unassigned after preview allocation
let previewAssigns = [];      // per-hall preview assignments
let finalAssigns = [];        // final after finalize
let halls = [];               // {id,name,rows,cols,y1,y2,y3,y4}
let hallCounter = 0;
let selectedStudentIdx = null; // index into previewUnassigned for manual assign

/* ====== helpers ====== */
function uid(){ return Math.floor(Math.random()*1e9).toString(36); }
function escapeHtml(s=''){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function normalizeRow(r){
  const map={};
  for(const k in r) if(Object.prototype.hasOwnProperty.call(r,k)) map[k.trim().toLowerCase()] = r[k];
  return {
    RollNo: map['roll no']||map['rollno']||map['roll']||'',
    Name: map['name of the student']||map['name']||'',
    Year: (map['year']||'').toString().trim(),
    Section: map['section']||'',
    SubjectCode: map['subject code']||map['subjectcode']||map['subject']||'',
    SubjectName: map['subject name']||map['subjectname']||''
  };
}
function normalizeYearVal(y){
  if(!y) return '';
  const v = String(y).trim().toLowerCase();
  if(v.startsWith('1') || v.startsWith('i')) return '1';
  if(v.startsWith('2') || v.startsWith('ii')) return '2';
  if(v.startsWith('3') || v.startsWith('iii')) return '3';
  if(v.startsWith('4') || v.startsWith('iv')) return '4';
  const m = v.match(/[1-4]/); return m?m[0]:'';
}
function colorForYear(y){
  if(y=='1') return 'var(--i-color)';
  if(y=='2') return 'var(--ii-color)';
  if(y=='3') return 'var(--iii-color)';
  if(y=='4') return 'var(--iv-color)';
  return 'var(--empty)';
}
function seatId(col,row){ return `${String.fromCharCode(65+col)}${row+1}`; }

/* ====== UI: halls management ====== */
function renderHallList(){
  const el=document.getElementById('hallList'); el.innerHTML='';
  halls.forEach(h=>{
    const d=document.createElement('div'); d.className='hall-item';
    d.innerHTML = `
      <input type="text" id="hall_name_${h.id}" value="${escapeHtml(h.name)}" placeholder="Hall name">
      <input type="number" id="hall_rows_${h.id}" value="${h.rows}" min="1" title="rows">
      <input type="number" id="hall_cols_${h.id}" value="${h.cols}" min="1" title="cols">
      <input type="number" id="year1_${h.id}" value="${h.y1||0}" min="0" placeholder="I" title="I year">
      <input type="number" id="year2_${h.id}" value="${h.y2||0}" min="0" placeholder="II" title="II year">
      <input type="number" id="year3_${h.id}" value="${h.y3||0}" min="0" placeholder="III" title="III year">
      <input type="number" id="year4_${h.id}" value="${h.y4||0}" min="0" placeholder="IV" title="IV year">
      <button class="btn ghost" data-remove="${h.id}">×</button>
    `;
    el.appendChild(d);
  });
  el.querySelectorAll('[data-remove]').forEach(b=>b.onclick=()=>{
    const id=b.getAttribute('data-remove'); halls = halls.filter(x=>x.id!==id); renderHallList();
  });
}
function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6){
  halls.push({ id: String(++hallCounter), name, rows, cols, y1:0,y2:0,y3:0,y4:0 });
  renderHallList();
}
function removeLastHall(){ if(halls.length){ halls.pop(); renderHallList(); } }

/* ====== file load / parse ====== */
document.getElementById('fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const name = (f.name||'').toLowerCase();
  try{
    if(name.endsWith('.csv')){
      const text = await f.text();
      const parsed = parseCSV(text);
      students = parsed.rows.map(normalizeRow);
    } else {
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data,{type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const arr = XLSX.utils.sheet_to_json(ws, {defval:''});
      students = arr.map(normalizeRow);
    }
    previewPool = students.slice();
    showMsg(`Loaded ${students.length} students`);
    renderStudentList();
    renderSummaryCounts();
  }catch(err){ showMsg('Failed to read file: '+err.message); }
});

/* CSV parse helper */
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return {rows:[]};
  const sep = lines[0].includes(',') ? ',' : '\t';
  const headers = lines[0].split(sep).map(h=>h.trim());
  const rows = lines.slice(1).map(l=>{
    const cols = l.split(sep).map(c=>c.trim()); const obj={};
    headers.forEach((h,i)=> obj[h]=cols[i]||''); return obj;
  });
  return {headers,rows};
}

/* sample loader */
document.getElementById('btnLoadSample').addEventListener('click', ()=>{
  students = [];
  const names = ['Alice','Bob','Cathy','Dinesh','Eve','Frank','Gita','Hari','Isha','John','Kumar','Lina','Mohan','Nila','Omar','Priya'];
  for(let i=0;i<80;i++){
    const y = ((i%4)+1).toString();
    students.push({
      RollNo: (1000+i),
      Name: names[i%names.length]+' '+(i+1),
      Year: y,
      Section: ['A','B','C'][i%3],
      SubjectCode: 'S' + (101 + (i%10)),
      SubjectName: 'Sub' + (i%10)
    });
  }
  previewPool = students.slice();
  showMsg(`Loaded sample ${students.length} students`);
  renderStudentList(); renderSummaryCounts();
});

/* template download */
document.getElementById('btnTemplate').addEventListener('click', ()=>{
  const ws = XLSX.utils.aoa_to_sheet([['Roll No','Name of the Student','Year','Section','Subject Code','Subject Name'], ['1001','Student One','1','A','CS101','Networks']]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Template');
  XLSX.writeFile(wb, 'Seating_Template.xlsx');
});

/* ====== preview allocation with constraints ====== */

/*
Approach:
- For each hall, try many attempts (randomized sampling) to select candidate students respecting per-hall year quotas (if set).
- For a candidate ordering, map to seats according to pattern and compute adjacent (left-right) conflicts:
    conflict if left seat exists and (same normalized year OR same subject code)
- Keep arrangement with zero conflicts or minimal conflicts after attempts (attempts up to MAX_ATTEMPTS).
- After allocating each hall in order, remove those students from pool and proceed to next hall.
*/

function readHallInputs(){
  // update halls array with latest inputs
  halls = halls.map(h=>{
    const name = document.getElementById(`hall_name_${h.id}`).value || h.name;
    const rows = Math.max(1, Number(document.getElementById(`hall_rows_${h.id}`).value) || h.rows);
    const cols = Math.max(1, Number(document.getElementById(`hall_cols_${h.id}`).value) || h.cols);
    const y1 = Math.max(0, Number(document.getElementById(`year1_${h.id}`).value) || 0);
    const y2 = Math.max(0, Number(document.getElementById(`year2_${h.id}`).value) || 0);
    const y3 = Math.max(0, Number(document.getElementById(`year3_${h.id}`).value) || 0);
    const y4 = Math.max(0, Number(document.getElementById(`year4_${h.id}`).value) || 0);
    return {...h, name, rows, cols, y1,y2,y3,y4};
  });
}

/* build seat order for pattern */
function buildSeatOrder(rows,cols,pattern){
  const order=[];
  if(pattern==='row'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) order.push({r,c}); }
  else if(pattern==='col'){ for(let c=0;c<cols;c++) for(let r=0;r<rows;r++) order.push({r,c}); }
  else if(pattern==='snake'){ for(let r=0;r<rows;r++){ if(r%2===0) for(let c=0;c<cols;c++) order.push({r,c}); else for(let c=cols-1;c>=0;c--) order.push({r,c}); } }
  else if(pattern==='alternate'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c+=2) order.push({r,c}); for(let r=0;r<rows;r++) for(let c=1;c<cols;c+=2) order.push({r,c}); }
  else { for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) order.push({r,c}); }
  return order;
}

/* compute conflict count given assigned array (sequence mapped to seat order) */
function countConflicts(assigns, cols){
  // assigns is array of student objects or null in row-major order
  let conflicts = 0;
  for(let i=0;i<assigns.length;i++){
    const s = assigns[i];
    if(!s) continue;
    // left neighbor exists if not first column
    if(i % cols !== 0){
      const left = assigns[i-1];
      if(left){
        const y1 = normalizeYearVal(s.Year), y2 = normalizeYearVal(left.Year);
        if(y1 && y1 === y2) conflicts++;
        else if((s.SubjectCode||'').toString().trim() && (left.SubjectCode||'').toString().trim() && (s.SubjectCode||'').toString().trim() === (left.SubjectCode||'').toString().trim()) conflicts++;
      }
    }
  }
  return conflicts;
}

/* pick students for a hall according to quotas (best effort), then try arrange to minimize conflicts */
function allocateHallWithConstraints(pool, hall, pattern, randomize, maxAttempts=400){
  const seats = hall.rows * hall.cols;
  // group pool by year
  const byYear = {'1':[], '2':[], '3':[], '4':[], '':[]};
  pool.forEach(s => {
    const y = normalizeYearVal(s.Year) || '';
    (byYear[y] = byYear[y]||[]).push(s);
  });

  // prepare desired quotas but cap them to available counts
  const desired = { '1': Math.max(0,hall.y1||0), '2': Math.max(0,hall.y2||0), '3': Math.max(0,hall.y3||0), '4': Math.max(0,hall.y4||0) };
  // reduce quotas if sum > seats
  let desiredSum = Object.values(desired).reduce((a,b)=>a+b,0);
  if(desiredSum > seats){
    // simple truncation from 4->1
    let over = desiredSum - seats;
    const order = ['4','3','2','1'];
    for(const k of order){
      if(over<=0) break;
      const take = Math.min(desired[k], over);
      desired[k] -= take; over -= take;
    }
  }

  // attempt sequences
  let best = {conflicts: Infinity, assigns: null, selectedStudents: null};
  const indices = pool.map((_,i)=>i);

  for(let attempt=0; attempt<maxAttempts; attempt++){
    // build candidate selection for hall
    // copy buckets
    const b = { '1': byYear['1'].slice(), '2': byYear['2'].slice(), '3': byYear['3'].slice(), '4': byYear['4'].slice(), '': byYear[''].slice() };

    // optionally shuffle buckets
    if(randomize){
      for(const k in b) shuffleArray(b[k]);
    }

    // pick per-year desired
    let selected = [];
    for(const k of ['1','2','3','4']){
      const need = desired[k];
      while(need>0 && selected.length < seats && b[k].length){
        selected.push(b[k].shift());
        // reduce need (we don't update variable need here; simpler to do a loop)
        desired[k]--; // temporarily reduce; revert after attempt
      }
    }

    // revert desired to original for next attempt: recompute from hall inputs (we will fetch again each attempt)
    // fill remaining from all buckets combined
    const remainingPool = [].concat(b['1'],b['2'],b['3'],b['4'],b['']);
    if(randomize) shuffleArray(remainingPool);
    while(selected.length < Math.min(seats, pool.length) && remainingPool.length){
      selected.push(remainingPool.shift());
    }

    // now selected length may be < seats if not enough students — pad with nulls
    while(selected.length < seats) selected.push(null);

    // Now we will attempt permutations to place students into seats trying to minimize left/right conflicts.
    // Instead of expensive permutations, try random shuffles of selected order and compute conflicts.
    const cols = hall.cols;
    let bestLocal = {conflicts: Infinity, order: selected.slice()};
    // try subattempts for reordering selected
    for(let r=0;r<6;r++){ // a few internal reshuffles
      const candidate = selected.slice();
      if(randomize) shuffleArray(candidate);
      const c = countConflicts(candidate, cols);
      if(c < bestLocal.conflicts){
        bestLocal = {conflicts: c, order: candidate.slice()};
        if(c === 0) break;
      }
    }
    // evaluate
    if(bestLocal.conflicts < best.conflicts){
     