<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating — Multi‑Hall Allotment</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root {
  --accent: #06b6d4;
  --accent2: #7c3aed;
  --muted: #94a3b8;
  --seat-bg: #f0f9ff;
  --seat-hover: #d1f0ff;
}
/* basic styling omitted for brevity (same as your previous code) */
.seat.year1{background:#ffecb3;} /* Year 1 */
.seat.year2{background:#c8e6c9;} /* Year 2 */
.seat.year3{background:#b3e5fc;} /* Year 3 */
.seat.year4{background:#f8bbd0;} /* Year 4 */
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo">ES</div>
  <div>
    <h1>Exam Seating — Multi‑Hall Allotment</h1>
    <p class="lead">Upload student sheet, choose halls & patterns, preview seat map and download final Excel.</p>
  </div>
</header>
<div class="main">
<div>
  <div class="card">
    <label>Date</label><input type="date" id="inpDate">
    <label>Department</label>
    <select id="inpDept">
      <option value="">-- Select --</option>
      <option value="CSE">CSE</option>
      <option value="ECE">ECE</option>
    </select>
    <label>Batch</label>
    <select id="inpBatch">
      <option value="">-- Select --</option>
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>
    <label>Upload Student File (.xlsx / .csv)</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    <div class="small">Template columns: <code>Roll No,Name of the Student,Year,Section,Subject Code,Subject Name</code></div>
    <div class="controls">
      <button class="btn" id="btnTemplate">Download Template</button>
      <button class="btn ghost" id="btnPreviewSample">Show Sample</button>
    </div>
    <hr style="margin:12px 0">
    <label>Halls (add 1..n)</label>
    <div class="hall-list" id="hallList"></div>
    <div class="add-hall">
      <button class="btn ghost" id="btnAddHall">+ Add Hall</button>
      <button class="btn" id="btnRemoveLast">Remove Last</button>
    </div>
    <hr style="margin:12px 0">
    <label>Seating Pattern</label>
    <select id="pattern">
      <option value="row">Row-wise</option>
      <option value="col">Column-wise</option>
      <option value="snake">Snake pattern</option>
      <option value="alternate">Alternate row</option>
      <option value="block">Block pattern</option>
    </select>
    <label style="margin-top:8px"><input type="checkbox" id="randomize" checked/> Randomize students before seating</label>
    <div style="margin-top:12px" class="controls">
      <button class="btn" id="btnPreview">Preview Seat Map</button>
      <button class="btn" id="btnGenerate">Download Excel</button>
      <button class="btn ghost" id="btnClear">Clear</button>
    </div>
    <div class="small" style="margin-top:8px">Same <strong>Subject Code</strong> will not be seated immediately left or right. Seats colored by <strong>Year</strong>.</div>
  </div>
</div>
<div>
  <div class="card preview-area">
    <div id="messages">No file loaded.</div>
    <div id="preview" style="min-height:220px"></div>
  </div>
</div>
</div>
<footer>Designed for offline use. Ensure xlsx.full.min.js is included.</footer>
</div>

<script>
(function(){
let students=[], halls=[], hallCounter=0;

function normalizeRow(r){
  const map={};
  for(const k in r) if(Object.prototype.hasOwnProperty.call(r,k)) map[k.trim().toLowerCase()] = r[k];
  return {
    RollNo: map['roll no']||'',
    Name: map['name of the student']||'',
    Year: map['year']||'',
    Section: map['section']||'',
    SubjectCode: map['subject code']||'',
    SubjectName: map['subject name']||''
  };
}

// Hall rendering and add/remove functions
function renderHallList(){ const container=document.getElementById('hallList'); container.innerHTML=''; halls.forEach(h=>{ const div=document.createElement('div'); div.className='hall-item'; div.innerHTML=`<input type='text' id='hall_name_${h.id}' value='${h.name}'><input type='number' id='hall_rows_${h.id}' value='${h.rows}' min='1'><input type='number' id='hall_cols_${h.id}' value='${h.cols}' min='1'><button type='button' data-remove='${h.id}' class='remove-btn' style='background:#ff6b6b;color:white;border:none;border-radius:6px;padding:6px'>×</button>`; container.appendChild(div); });
container.querySelectorAll('.remove-btn').forEach(btn=> btn.addEventListener('click', ()=>{ const id=Number(btn.getAttribute('data-remove')); halls=halls.filter(x=>x.id!==id); renderHallList(); })); }

function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6){ hallCounter++; halls.push({id:hallCounter,name,rows,cols}); renderHallList(); }
function removeLastHall(){ if(halls.length){ halls.pop(); hallCounter--; renderHallList(); } }

function parseCSV(text){ const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean); if(!lines.length) return {rows:[]}; const sep=lines[0].includes(',') ? ',' : '\t'; const headers=lines[0].split(sep).map(h=>h.trim()); const rows=lines.slice(1).map(l=>{ const cols=l.split(sep).map(c=>c.trim()); const obj={}; headers.forEach((h,i)=> obj[h]=cols[i]||''); return obj; }); return {headers,rows}; }

function showMessage(msg){ document.getElementById('messages').innerHTML=`<strong>${msg}</strong>`; }

document.getElementById('btnTemplate').addEventListener('click', ()=>{ const headers=['Roll No','Name of the Student','Year','Section','Subject Code','Subject Name']; const ws=XLSX.utils.aoa_to_sheet([headers,['12345','Student One','3','A','CS301','Networks']]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Template'); XLSX.writeFile(wb,'Seating_Upload_Template.xlsx'); });

document.getElementById('btnPreviewSample').addEventListener('click', ()=>{ const preview=document.getElementById('preview'); preview.innerHTML='<div class="small">Sample table preview here</div>'; });

document.getElementById('fileInput').addEventListener('change', async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name.toLowerCase();
  if(name.endsWith('.csv')){ const text=await f.text(); const parsed=parseCSV(text); students=parsed.rows.map(normalizeRow); showMessage(`Loaded ${students.length} records from CSV`); return; }
  try{ const data=await f.arrayBuffer(); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const arr=XLSX.utils.sheet_to_json(ws,{defval:''}); students=arr.map(normalizeRow); showMessage(`Loaded ${students.length} records from Excel`); }
  catch(err){ showMessage('Failed to read file: '+err.message); }
});

// Build seat order, allocate students avoiding same subject side by side
function buildSeatOrder(rows,cols,pattern){ const order=[]; if(pattern==='row'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) order.push({r,c}); } else if(pattern==='col'){ for(let c=0;c<cols;c++) for(let r=0;r<rows;r++) order.push({r,c}); } else if(pattern==='snake'){ for(let r=0;r<rows;r++){ if(r%2===0) for(let c=0;c<cols;c++) order.push({r,c}); else for(let c=cols-1;c>=0;c--) order.push({r,c}); } } else if(pattern==='alternate'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c+=2) order.push({r,c}); for(let r=0;r<rows;r++) for(let c=1;c<cols;c+=2) order.push({r,c}); } else if(pattern==='block'){ const blockR=Math.max(1,Math.floor(rows/2)); const blockC=Math.max(1,Math.floor(cols/2)); for(let br=0;br<rows;br+=blockR) for(let bc=0;bc<cols;bc+=blockC) for(let r=br;r<Math.min(rows,br+blockR);r++) for(let c=bc;c<Math.min(cols,bc+blockC);c++) order.push({r,c}); } return order; }

function allocateToHall(stuList, rows, cols, pattern, randomize=true){
  const seats=Array.from({length:rows},()=>Array.from({length:cols},()=>null));
  let pool=stuList.slice(); if(randomize) pool.sort(()=>Math.random()-0.5);
  const order=buildSeatOrder(rows,cols,pattern);
  for(const pos of order){
    if(!pool.length) break;
    const left=pos.c>0?seats[pos.r][pos.c-1]:null;
    let idx=pool.findIndex(s=>!left||(s.SubjectCode!=left.SubjectCode));
    if(idx==-1) idx=0;
    seats[pos.r][pos.c]=pool.splice(idx,1)[0];
  }
  const assigned=[]; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) assigned.push({row:r,col:c,student:seats[r][c],SeatingNo:String.fromCharCode(65+c)+(r+1)}); return {assigned,remaining:pool};
}

function renderPreview(rows){
  const preview=document.getElementById('preview'); preview.innerHTML='';
  rows.forEach(hc=>{
    const visual=document.createElement('div'); visual.className='seatmap';
    visual.innerHTML=`<strong>${hc.HallNo}</strong>`;
    for(let r=0;r<hc.rows;r++){
      const rowDiv=document.createElement('div'); rowDiv.className='seat-row';
      const rowLabel=document.createElement('div'); rowLabel.className='row-label'; rowLabel.textContent=r+1; rowDiv.appendChild(rowLabel);
      for(let c=0;c<hc.cols;c++){
        const seatDiv=document.createElement('div'); seatDiv.className='seat';
        const rec=hc.assigned.find(x=>x.row===r && x.col===c);
        if(rec && rec.student){ seatDiv.innerHTML=`<div>${rec.SeatingNo}</div><div>${rec.student.RollNo}</div>`; const y=rec.student.Year||''; seatDiv.classList.add('year'+y); const tooltip=document.createElement('div'); tooltip.className='tooltip'; tooltip.innerHTML=`${rec.student.Name}<br>${rec.student.SubjectCode}`; seatDiv.appendChild(tooltip); }
        else seatDiv.classList.add('empty'), seatDiv.textContent=String.fromCharCode(65+c)+(r+1);
        rowDiv.appendChild(seatDiv);
      }
      visual.appendChild(rowDiv);
    }
    preview.appendChild(visual);
  });
}

document.getElementById('btnPreview').addEventListener('click', ()=>{
  if(!students.length){ alert('Upload student file first'); return; }
  const pattern=document.getElementById('pattern').value;
  const randomize=document.getElementById('randomize').checked;
  const hallsConfig=halls.map(h=>({HallNo:document.getElementById(`hall_name_${h.id}`).value||h.name,rows:Number(document.getElementById(`hall_rows_${h.id}`).value)||h.rows,cols:Number(document.getElementById(`hall_cols_${h.id}`).value)||h.cols}));
  let remaining=students.slice(); const finalResult=[];
  hallsConfig.forEach(hc=>{ const {assigned,remaining:rem}=allocateToHall(remaining,hc.rows,hc.cols,pattern,randomize); finalResult.push({...hc,assigned}); remaining=rem; });
  renderPreview(finalResult);
});

document.getElementById('btnGenerate').addEventListener('click', ()=>{
  if(!students.length){ alert('Upload student file first'); return; }
  const date=document.getElementById('inpDate').value;
  const dept=document.getElementById('inpDept').value;
  const batch=document.getElementById('inpBatch').value;
  if(!date||!dept||!batch){ alert('Fill Date, Department and Batch'); return; }
  const pattern=document.getElementById('pattern').value;
  const randomize=document.getElementById('randomize').checked;
  const hallsConfig=halls.map(h=>({HallNo:document.getElementById(`hall_name_${h.id}`).value||h.name,rows:Number(document.getElementById(`hall_rows_${h.id}`).value)||h.rows,cols:Number(document.getElementById(`hall_cols_${h.id}`).value)||h.cols}));
  let remaining=students.slice(); const finalResult=[];
  hallsConfig.forEach(hc=>{ const {assigned,remaining:rem}=allocateToHall(remaining,hc.rows,hc.cols,pattern,randomize); finalResult.push({...hc,assigned}); remaining=rem; });
  
  // Excel
  const wb=XLSX.utils.book_new();
  finalResult.forEach(hc=>{
    const wsData=[['Date','Department','Batch','HallNo','RollNo','Name','Seating No','SubjectCode','Subject','Year','Section']];
    hc.assigned.forEach(s=>{
      if(s.student) wsData.push([date,dept,batch,hc.HallNo,s.student.RollNo,s.student.Name,s.SeatingNo,s.student.SubjectCode,s.student.SubjectName,s.student.Year,s.student.Section]);
    });
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,hc.HallNo);
  });
  XLSX.writeFile(wb,`${dept}_${batch}_${date}_Seating.xlsx`);
});

document.getElementById('btnAddHall').addEventListener('click',()=>addHall());
document.getElementById('btnRemoveLast').addEventListener('click',()=>removeLastHall());
document.getElementById('btnClear').addEventListener('click',()=>{ students=[]; halls=[]; hallCounter=0; document.getElementById('preview').innerHTML=''; document.getElementById('messages').innerHTML='No file loaded.'; renderHallList(); });
})();
</script>
</body>
</html>
