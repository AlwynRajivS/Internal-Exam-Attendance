<!doctype html> 
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating â€” Multiâ€‘Hall Allotment</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root {
  --accent:#06b6d4; --accent2:#7c3aed; --muted:#94a3b8;
  --seat-bg:#f0f9ff; --seat-hover:#d1f0ff;
  --yearI:#60a5fa; --yearII:#4ade80; --yearIII:#fbbf24; --yearIV:#f87171;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Poppins,system-ui,Arial;background:linear-gradient(180deg,#e6f9ff,#f7f5ff);color:#052029;padding:10px;}
.wrap{max-width:1200px;margin:0 auto;}
header{display:flex;align-items:center;gap:16px;margin-bottom:18px;flex-wrap:wrap;}
.logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;}
h1{font-size:22px;margin:0;}
p.lead{color:#0b5564;font-size:14px;}
.main{display:grid;grid-template-columns:380px 1fr;gap:18px;}
.card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(13,38,52,0.06);}
label{display:block;font-size:13px;color:#073741;margin-top:8px;}
select,input[type=text],input[type=date],input[type=number],button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(3,37,45,0.06);font-size:14px;}
.row{display:flex;gap:8px;}
.small{font-size:12px;color:var(--muted);}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;cursor:pointer;border:none;padding:10px;border-radius:8px;font-weight:700;transition:0.3s;}
.btn:hover{opacity:0.9;}
.btn.ghost{background:transparent;border:1px solid rgba(3,37,45,0.06);color:#073741;}
.hall-list{display:flex;flex-direction:column;gap:10px;}
.hall-item{display:grid;grid-template-columns:1fr repeat(7,60px);gap:6px;align-items:center;}
.add-hall{display:flex;gap:8px;margin-top:10px;}
.preview-area{display:grid;gap:12px;}
.seatmap{display:flex;flex-direction:column;gap:10px;padding:10px;border-radius:12px;background:linear-gradient(180deg,#f8fcff,#fbf7ff);}
.seat-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;}
.row-label{width:30px;text-align:center;color:var(--muted);font-weight:600;}
.seat{min-width:56px;height:48px;border-radius:8px;background:var(--seat-bg);border:1px solid #e6eef3;display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:12px;position:relative;transition:0.3s;}
.seat.I{background:var(--yearI);}
.seat.II{background:var(--yearII);}
.seat.III{background:var(--yearIII);}
.seat.IV{background:var(--yearIV);}
.seat:hover{background:var(--seat-hover);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:8px;border:1px solid #e6eef3;text-align:left;font-size:13px;}
th{background:#edf7fb;}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap;}
footer{margin-top:12px;color:#6a7d86;font-size:13px;}
@media(max-width:980px){.main{grid-template-columns:1fr;}}
</style>
</head>

<body>
<div class="wrap">

<header>
  <div class="logo">ES</div>
  <div>
    <h1>Exam Seating â€” Multiâ€‘Hall Allotment</h1>
    <p class="lead">Upload student sheet, choose halls, preview seating, auto & manual drag-drop, download final Excel.</p>
  </div>
</header>

<div class="main">

<div>
  <div class="card">

    <label>Date</label>
    <input type="date" id="inpDate">

    <label>Department</label>
    <select id="inpDept">
      <option value="">-- Select --</option>
      <option value="CSE">CSE</option>
      <option value="ECE">ECE</option>
    </select>

    <label>Batch</label>
    <select id="inpBatch">
      <option value="">-- Select --</option>
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>

    <label>Upload Student File (.xlsx / .csv)</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    <div class="small">Template columns: <code>Roll No,Name,Year,Section,Subject Code,Subject Name</code></div>
    <div class="controls">
      <button class="btn" id="btnTemplate">Download Template</button>
      <button class="btn ghost" id="btnPreviewSample">Show Sample</button>
    </div>

    <hr>
    <label>Halls (add/remove)</label>
    <div class="hall-list" id="hallList"></div>
    <div class="add-hall">
      <button class="btn ghost" id="btnAddHall">+ Add Hall</button>
      <button class="btn" id="btnRemoveLast">Remove Last</button>
    </div>

    <div class="small" id="assignCounter" style="margin-top:6px"></div>
    <hr>

    <div class="controls">
      <button class="btn" id="btnPreview">Preview Seating</button>
      <button class="btn" id="btnGenerateExcel">ðŸ’¾ Generate Excel</button>
      <button class="btn ghost" id="btnClear">Clear</button>
    </div>

  </div>
</div>

<div>
  <div class="card preview-area">
    <div id="messages">No file loaded.</div>
    <div id="preview" style="min-height:220px"></div>
  </div>
</div>

</div>

<footer>Designed for offline use. Mobile-friendly & touch support included.</footer>

</div>

<script>
(function(){
let students=[], halls=[], hallCounter=0;

function normalizeRow(r){
  const map={};
  for(const k in r) map[k.trim().toLowerCase()]=r[k];
  const roll=map['roll no']||map['rollno']||map['roll']||'';
  const name=map['name of the student']||map['name']||'';
  const year=map['year']||''; const section=map['section']||'';
  const subj=map['subject code']||map['subjectcode']||''; const subjname=map['subject name']||map['subjectname']||'';
  return {RollNo:roll,Name:name,Year:year,Section:section,SubjectCode:subj,SubjectName:subjname};
}

function renderHallList(){
  const container=document.getElementById('hallList'); container.innerHTML='';
  halls.forEach(h=>{
    const div=document.createElement('div'); div.className='hall-item';
    div.innerHTML=`
      <input type='text' id='hall_name_${h.id}' value='${h.name}' placeholder='Hall Name'>
      <input type='number' id='hall_rows_${h.id}' value='${h.rows}' min='1' placeholder='Rows'>
      <input type='number' id='hall_cols_${h.id}' value='${h.cols}' min='1' placeholder='Cols'>
      <input type='number' id='hall_I_${h.id}' value='0' placeholder='I Yr'>
      <input type='number' id='hall_II_${h.id}' value='0' placeholder='II Yr'>
      <input type='number' id='hall_III_${h.id}' value='0' placeholder='III Yr'>
      <input type='number' id='hall_IV_${h.id}' value='0' placeholder='IV Yr'>
      <select id='hall_pattern_${h.id}' style='padding:6px;border-radius:6px;'>
        <option value='row' ${h.pattern==='row'?'selected':''}>Row</option>
        <option value='column' ${h.pattern==='column'?'selected':''}>Column</option>
        <option value='zigzag' ${h.pattern==='zigzag'?'selected':''}>Zigzag</option>
        <option value='alternate' ${h.pattern==='alternate'?'selected':''}>Alternate</option>
      </select>
      <button type='button' data-remove='${h.id}' class='remove-btn' style='background:#ff6b6b;color:white;border:none;border-radius:6px;padding:6px'>Ã—</button>
    `;
    container.appendChild(div);
  });
  container.querySelectorAll('.remove-btn').forEach(btn=> btn.addEventListener('click', ()=>{
    const id=Number(btn.getAttribute('data-remove')); halls=halls.filter(x=>x.id!==id); renderHallList();
  }));
}

function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6, pattern='row'){ hallCounter++; halls.push({id:hallCounter,name,rows,cols,pattern}); renderHallList(); }
function removeLastHall(){ if(halls.length){ halls.pop(); hallCounter--; renderHallList(); } }
function showMessage(msg){ document.getElementById('messages').innerHTML=`<strong>${msg}</strong>`; }

function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(Boolean);
  const sep=lines[0].includes(',')? ',':'\t';
  const headers=lines[0].split(sep).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{const cols=l.split(sep).map(c=>c.trim()); const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]||''); return obj;});
  return {headers,rows};
}

document.getElementById('fileInput').addEventListener('change',async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name.toLowerCase();
  try{
    if(name.endsWith('.csv')){
      const text=await f.text();
      students=parseCSV(text).rows.map(normalizeRow);
    } else {
      const data=await f.arrayBuffer();
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      students=XLSX.utils.sheet_to_json(ws,{defval:''}).map(normalizeRow);
    }
    showMessage(`Loaded ${students.length} students.`);
  }catch(err){ showMessage('Failed to load file: '+err.message); }
});

document.getElementById('btnTemplate').addEventListener('click',()=>{
  const headers=['Roll No','Name of the Student','Year','Section','Subject Code','Subject Name'];
  const ws=XLSX.utils.aoa_to_sheet([headers,['12345','Student One','I','A','CS101','Math']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Template');
  XLSX.writeFile(wb,'Seating_Template.xlsx');
});

function seatId(c,r){ return `${String.fromCharCode(65+c)}${r+1}`; }

function buildSeatOrder(rows, cols, pattern = "row") {
  const order = [];
  if (pattern === "row") {
    for (let r = 0; r < rows; r++)
      for (let c = 0; c < cols; c++) order.push({ r, c });
  } else if (pattern === "column") {
    for (let c = 0; c < cols; c++)
      for (let r = 0; r < rows; r++) order.push({ r, c });
  } else if (pattern === "zigzag") {
    for (let r = 0; r < rows; r++) {
      if (r % 2 === 0)
        for (let c = 0; c < cols; c++) order.push({ r, c });
      else
        for (let c = cols - 1; c >= 0; c--) order.push({ r, c });
    }
  } else if (pattern === "alternate") {
    for (let c = 0; c < cols; c += 2)
      for (let r = 0; r < rows; r++) order.push({ r, c });
    for (let c = 1; c < cols; c += 2)
      for (let r = 0; r < rows; r++) order.push({ r, c });
  }
  return order;
}

function allocateToHall(stuList, hall){
  const rows = Number(hall.rows), cols = Number(hall.cols);
  const seats = Array.from({length: rows}, () => Array.from({length: cols}, () => null));
  const pattern = hall.pattern || "row";
  const order = buildSeatOrder(rows, cols, pattern);
  let pool = stuList.slice();

  const yearCounts = {I: Number(hall.I), II: Number(hall.II), III: Number(hall.III), IV: Number(hall.IV)};
  const yearPools = {I: [], II: [], III: [], IV: []};
  pool.forEach(s => { if(yearPools[s.Year]) yearPools[s.Year].push(s); });

  function canSitHere(stu,left,right){
    if(!stu) return false;
    if((left && stu.SubjectCode===left.SubjectCode)||(right && stu.SubjectCode===right.SubjectCode)) return false;
    return true;
  }

  for(const pos of order){
    let assigned=false;
    const left = pos.c>0?seats[pos.r][pos.c-1]:null;
    const right = pos.c<cols-1?seats[pos.r][pos.c+1]:null;

    for(const yr of ['I','II','III','IV']){
      if(yearCounts[yr]>0 && yearPools[yr].length){
        let idx = yearPools[yr].findIndex(s=>canSitHere(s,left,right));
        if(idx===-1) continue;
        seats[pos.r][pos.c]=yearPools[yr].splice(idx,1)[0];
        yearCounts[yr]--; assigned=true; break;
      }
    }

    if(!assigned && pool.length){
      let idx = pool.findIndex(s=>canSitHere(s,left,right));
      if(idx===-1) idx=0;
      seats[pos.r][pos.c]=pool.splice(idx,1)[0];
    }
  }

  const assigned=[];
  for(let r=0;r<rows;r++)
    for(let c=0;c<cols;c++)
      assigned.push({row:r,col:c,student:seats[r][c],SeatingNo:seatId(c,r)});

  return {assigned,remaining:pool};
}

function renderPreview(){
  if(!students.length){ document.getElementById('preview').innerHTML='No data'; return; }
  const preview=document.getElementById('preview'); preview.innerHTML='';
  let remainingStudents=students.slice(); let totalAssigned=0;

  halls.forEach(h=>{
    const hallConf={
      name: document.getElementById(`hall_name_${h.id}`).value || h.name,
      rows:Number(document.getElementById(`hall_rows_${h.id}`).value)||h.rows,
      cols:Number(document.getElementById(`hall_cols_${h.id}`).value)||h.cols,
      I:Number(document.getElementById(`hall_I_${h.id}`).value)||0,
      II:Number(document.getElementById(`hall_II_${h.id}`).value)||0,
      III:Number(document.getElementById(`hall_III_${h.id}`).value)||0,
      IV:Number(document.getElementById(`hall_IV_${h.id}`).value)||0,
      pattern: document.getElementById(`hall_pattern_${h.id}`).value || h.pattern
    };
    const {assigned,remaining}=allocateToHall(remainingStudents,hallConf); remainingStudents=remaining;
    totalAssigned+=assigned.filter(a=>a.student).length;

    const hallDiv=document.createElement('div'); hallDiv.className='seatmap';
    hallDiv.innerHTML=`<strong>${hallConf.name}</strong>`;
    for(let r=0;r<hallConf.rows;r++){
      const rowDiv=document.createElement('div'); rowDiv.className='seat-row';
      const label=document.createElement('div'); label.className='row-label'; label.textContent=r+1; rowDiv.appendChild(label);
      for(let c=0;c<hallConf.cols;c++){
        const seatDiv=document.createElement('div'); seatDiv.className='seat empty'; 
        const s=assigned.find(a=>a.row===r && a.col===c); 
        if(s && s.student){ 
          seatDiv.className='seat '+s.student.Year; 
          seatDiv.textContent=s.student.RollNo; 
          seatDiv.setAttribute('data-name',s.student.Name); 
          seatDiv.setAttribute('data-year',s.student.Year); 
          seatDiv.setAttribute('data-subject',s.student.SubjectCode); 
          seatDiv.title=`${s.student.Name} | ${s.student.SubjectCode}`;
        } 
        rowDiv.appendChild(seatDiv);
      }
      hallDiv.appendChild(rowDiv);
    }
    preview.appendChild(hallDiv);
  });
  document.getElementById('assignCounter').textContent=`Assigned ${totalAssigned} / ${students.length}`;
}

document.getElementById('btnAddHall').addEventListener('click',()=>addHall());
document.getElementById('btnRemoveLast').addEventListener('click',()=>removeLastHall());
document.getElementById('btnPreview').addEventListener('click',()=>renderPreview());
document.getElementById('btnClear').addEventListener('click',()=>{
  students=[]; halls=[]; hallCounter=0;
  document.getElementById('preview').innerHTML=''; document.getElementById('messages').innerHTML='No file loaded';
  renderHallList(); document.getElementById('assignCounter').textContent='';
});

//Generate 
document.getElementById('btnGenerateExcel').addEventListener('click',()=>{
  const date=document.getElementById('inpDate').value||'';
  const dept=document.getElementById('inpDept').value||'';
  const batch=document.getElementById('inpBatch').value||'';

  if(!halls.length){ alert('Add halls first'); return; }
  if(!students.length){ alert('Load student file first'); return; }

  // We'll rebuild seating like in preview and store all assigned seats
  let remainingStudents = students.slice();
  const allData = [];

  halls.forEach(h=>{
    const hallConf={
      name: document.getElementById(`hall_name_${h.id}`).value || h.name,
      rows:Number(document.getElementById(`hall_rows_${h.id}`).value)||h.rows,
      cols:Number(document.getElementById(`hall_cols_${h.id}`).value)||h.cols,
      I:Number(document.getElementById(`hall_I_${h.id}`).value)||0,
      II:Number(document.getElementById(`hall_II_${h.id}`).value)||0,
      III:Number(document.getElementById(`hall_III_${h.id}`).value)||0,
      IV:Number(document.getElementById(`hall_IV_${h.id}`).value)||0,
      pattern: document.getElementById(`hall_pattern_${h.id}`).value || h.pattern
    };
    const {assigned, remaining} = allocateToHall(remainingStudents, hallConf);
    remainingStudents = remaining;  // update for next hall

    assigned.forEach(a=>{
      if(a.student) allData.push({
        Date: date,
        Dept: dept,
        Batch: batch,
        Hall: hallConf.name,
        SeatingNo: a.SeatingNo,
        RollNo: a.student.RollNo,
        Name: a.student.Name,
        Year: a.student.Year,
        Section: a.student.Section,
        SubjectCode: a.student.SubjectCode,
        SubjectName: a.student.SubjectName
      });
    });
  });

  if(!allData.length){ alert('No seating assigned'); return; }

  const ws = XLSX.utils.json_to_sheet(allData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Seating');
  XLSX.writeFile(wb, `${dept||'Exam'}_Seating.xlsx`);
});




});
})();
</script>

</body>
</html>
