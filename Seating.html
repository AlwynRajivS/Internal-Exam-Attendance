<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating — Multi-Hall Allotment</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

:root{
--accent:#06b6d4; --accent2:#7c3aed; --muted:#94a3b8;
--seat-bg:#f0f9ff; --seat-hover:#d1f0ff;
--yearI:#60a5fa; --yearII:#4ade80; --yearIII:#fbbf24; --yearIV:#f87171;
}

*{box-sizing:border-box;margin:0;padding:0;}

body{
font-family:Poppins,system-ui,Arial;
background:linear-gradient(180deg,#e6f9ff,#f7f5ff);
color:#052029;padding:10px;
}

.wrap{max-width:1200px;margin:0 auto;}
header{display:flex;align-items:center;gap:16px;margin-bottom:18px;flex-wrap:wrap;}
.logo{width:64px;height:64px;border-radius:12px;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
color:white;font-weight:700;font-size:20px;}
h1{font-size:22px;}

.main{display:grid;grid-template-columns:380px 1fr;gap:18px;}
.card{background:white;border-radius:25px;padding:16px;
box-shadow:0 6px 24px rgba(13,38,52,0.06);width:100%}

label{display:block;font-size:13px;color:#073741;margin-top:10px;}
select,input[type=text],input[type=date],input[type=number],button{
width:100%;padding:10px;border-radius:8px;
border:1px solid rgba(3,37,45,0.06);font-size:14px;
}

.small{font-size:12px;color:var(--muted);}
.btn{
background:linear-gradient(90deg,var(--accent),var(--accent2));
color:#021;cursor:pointer;border:none;
padding:10px;border-radius:8px;font-weight:700;
}

.btn.ghost{background:transparent;border:1px solid rgba(3,37,45,0.06);}

.seatmap{display:flex;flex-direction:column;gap:10px;
padding:10px;border-radius:12px;
background:linear-gradient(180deg,#f8fcff,#fbf7ff);}

.seat-row{display:flex;gap:2px;align-items:center;flex-wrap:wrap;}
.row-label{width:60px;text-align:center;color:var(--muted);font-weight:600;}

.seat{
min-width:60px;height:30px;border-radius:8px;
background:var(--seat-bg);
border:1px solid #e6eef3;
display:flex;align-items:center;justify-content:center;
flex-direction:column;font-size:10px;cursor:pointer;
}

.seat.I{background:var(--yearI);}
.seat.II{background:var(--yearII);}
.seat.III{background:var(--yearIII);}
.seat.IV{background:var(--yearIV);}

@media(max-width:980px){
.main{grid-template-columns:1fr;}
.seat{min-width:40px;height:20px;font-size:6px;}
.row-label{width:20px;font-size:8px;}
}
</style>
</head>

<body>

<div class="wrap">

<header>
<div class="logo">ES</div>
<div><h1>Exam Seating — Multi-Hall Allotment</h1></div>
</header>

<div class="main">

<div>
<div class="card">

<label>Date</label>
<input type="date" id="inpDate">

<label>Department</label>
<select id="inpDept">
<option value="">-- Select --</option>
<option value="CSE">CSE</option>
<option value="ECE">ECE</option>
<option value="EEE">EEE</option>
<option value="IT">IT</option>
<option value="BT">BT</option>
<option value="ME">ME</option>
<option value="MTR">MTR</option>
<option value="CE">CIVIL</option>
<option value="ADS">ADS</option>
<option value="FY">FY</option>
</select>

<label>Batch</label>
<select id="inpBatch">
<option value="">-- Select --</option>
<option value="FN">FN</option>
<option value="AN">AN</option>
</select>

<label>Upload Student File</label>
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

<div class="small">
Template: Roll No, Name, Year, Section, Subject Code, Subject Name
</div>

<br>
<button class="btn" id="btnTemplate">Download Template</button>

<hr>

<div id="hallList"></div>

<button class="btn ghost" id="btnAddHall">+ Add Hall</button>
<button class="btn" id="btnRemoveLast">Remove Last</button>

<hr>

<button class="btn" id="btnPreview">Preview</button>
<button class="btn" id="btnGenerate">Generate Excel</button>

</div>
</div>

<div>
<div class="card">
<div id="messages">No file loaded.</div>
<div id="preview"></div>
</div>
</div>

</div>
</div>

<script>
(function(){

let students=[], halls=[], hallCounter=0;

/* ================= DEFAULT PATTERN COLUMN ================= */
function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6, pattern='column'){
hallCounter++;
halls.push({id:hallCounter,name,rows,cols,pattern});
renderHallList();
}

function renderHallList(){
const c=document.getElementById('hallList');
c.innerHTML='';
halls.forEach(h=>{
c.innerHTML+=`
<label>Hall Name</label>
<input id="hall_name_${h.id}" value="${h.name}">
<label>Rows</label>
<input type="number" id="hall_rows_${h.id}" value="${h.rows}">
<label>Cols</label>
<input type="number" id="hall_cols_${h.id}" value="${h.cols}">
`;
});
}

function normalizeRow(r){
return{
RollNo:r['Roll No']||'',
Name:r['Name']||'',
Year:r['Year']||'',
Section:r['Section']||'',
SubjectCode:r['Subject Code']||'',
SubjectName:r['Subject Name']||''
};
}

document.getElementById('fileInput').addEventListener('change',async e=>{
const f=e.target.files[0];
const data=await f.arrayBuffer();
const wb=XLSX.read(data,{type:'array'});
const ws=wb.Sheets[wb.SheetNames[0]];
students=XLSX.utils.sheet_to_json(ws,{defval:''}).map(normalizeRow);
document.getElementById('messages').innerText=
`Loaded ${students.length} students`;
});

function seatId(c,r){return `${String.fromCharCode(65+c)}${r+1}`;}

function renderPreview(){
const preview=document.getElementById('preview');
preview.innerHTML='';

halls.forEach(h=>{
const hallDiv=document.createElement('div');
hallDiv.className='seatmap';
hallDiv.innerHTML=`<strong>${h.name}</strong>`;

let idx=0;

for(let r=0;r<h.rows;r++){
const rowDiv=document.createElement('div');
rowDiv.className='seat-row';

const label=document.createElement('div');
label.className='row-label';
label.textContent=r+1;
rowDiv.appendChild(label);

for(let c=0;c<h.cols;c++){
const seat=document.createElement('div');
seat.className='seat';

if(students[idx]){
seat.className='seat '+students[idx].Year;
seat.textContent=students[idx].RollNo;
seat.setAttribute('data-name',students[idx].Name);
seat.setAttribute('data-year',students[idx].Year);
seat.setAttribute('data-section',students[idx].Section);
seat.setAttribute('data-subject',students[idx].SubjectCode);
seat.setAttribute('data-subjectname',students[idx].SubjectName); /* FIXED */
}
rowDiv.appendChild(seat);
idx++;
}
hallDiv.appendChild(rowDiv);
}
preview.appendChild(hallDiv);
});
}

/* ================= EXCEL GENERATION FIXED ================= */
document.getElementById('btnGenerate').addEventListener('click',()=>{
const date=document.getElementById('inpDate').value;
const dept=document.getElementById('inpDept').value;
const batch=document.getElementById('inpBatch').value;

if(!date||!dept||!batch){
alert("Fill Date, Department, Batch");
return;
}

const wb=XLSX.utils.book_new();
const wsData=[[
'Date','Department','Batch','Hall No',
'Student Roll No','Name','Seating No',
'Subject Code','Subject','Year','Section'
]];

document.querySelectorAll('.seatmap').forEach(hall=>{
const hallName=hall.querySelector('strong').textContent;

hall.querySelectorAll('.seat-row').forEach((rowDiv,rowIdx)=>{
rowDiv.querySelectorAll('.seat').forEach((seat,colIdx)=>{
if(seat.textContent){
wsData.push([
date,
dept,
batch,
hallName,
seat.textContent,
seat.getAttribute('data-name'),
`${String.fromCharCode(65+colIdx)}${rowIdx+1}`,
seat.getAttribute('data-subject'),
seat.getAttribute('data-subjectname'), /* FIXED */
seat.getAttribute('data-year'),
seat.getAttribute('data-section')
]);
}
});
});
});

const ws=XLSX.utils.aoa_to_sheet(wsData);
XLSX.utils.book_append_sheet(wb,ws,'Seating');
XLSX.writeFile(wb,`${dept}_${batch}_${date}_Seating.xlsx`);

alert("Excel Generated Successfully");
});

document.getElementById('btnAddHall')
.addEventListener('click',()=>addHall());

document.getElementById('btnPreview')
.addEventListener('click',renderPreview);

})();
</script>

</body>
</html>
