<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating ‚Äî Hall & Year-wise</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --y1:#007bff; --y2:#28a745; --y3:#fd7e14; --y4:#dc3545; --empty:#f1f1f1;
  }
  body { font-family:'Poppins',sans-serif; margin:0; background:#f7f9fc; color:#222; }
  h1{ text-align:center; padding:10px; background:#1e90ff; color:#fff; }
  .container{ max-width:1200px; margin:auto; padding:10px; }
  .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin-bottom:15px; }
  input,select,button{ padding:8px 12px; border-radius:6px; border:1px solid #ccc; }
  button{ cursor:pointer; background:#007bff; color:#fff; border:none; transition:.3s; }
  button:hover{ background:#0056b3; }
  .hall-config{ background:#fff; padding:10px; margin-top:10px; border-radius:10px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
  .hall-config h3{ margin:0 0 8px 0; }
  .seatmap{ margin-top:10px; overflow:auto; background:#fff; border-radius:10px; padding:10px; box-shadow:0 0 5px rgba(0,0,0,0.1); }
  .seat-row{ display:flex; align-items:center; }
  .row-label{ width:20px; font-weight:bold; margin-right:5px; }
  .seat{ width:28px; height:28px; border:1px solid #ccc; text-align:center; line-height:28px; margin:1px; border-radius:4px; font-size:12px; user-select:none; }
  .I{ background:var(--y1); color:#fff; }
  .II{ background:var(--y2); color:#fff; }
  .III{ background:var(--y3); color:#fff; }
  .IV{ background:var(--y4); color:#fff; }
  .empty{ background:var(--empty); }
  .counters{ text-align:center; margin-top:10px; font-weight:bold; }
  @media(max-width:768px){
    .seat{ width:22px; height:22px; line-height:22px; font-size:10px; }
  }
</style>
</head>
<body>
<h1>üéì Exam Seating ‚Äî Year-wise Allocation</h1>
<div class="container">
  <div class="toolbar">
    <input type="date" id="inpDate">
    <select id="inpDept"><option value="">Department</option><option>CSE</option><option>ECE</option><option>EEE</option><option>BT</option></select>
    <select id="inpBatch"><option value="">Batch</option><option>FN</option><option>AN</option></select>
    <input type="file" id="fileInput" accept=".csv,.xlsx">
    <button id="btnTemplate">‚¨áÔ∏è Download Template</button>
    <button id="btnAddHall">‚ûï Add Hall</button>
    <button id="btnRemoveLast">‚ûñ Remove Last Hall</button>
    <button id="btnPreview">üëÅÔ∏è Preview</button>
    <button id="btnGenerate">üì• Export Excel</button>
    <button id="btnClear">üóëÔ∏è Clear</button>
  </div>
  <div id="hallContainer"></div>
  <div id="preview" class="seatmap" style="text-align:center;">No file loaded.</div>
  <div class="counters" id="assignCounter"></div>
</div>

<script>
(() => {
let students=[], halls=[], hallCounter=0;
const hallContainer=document.getElementById('hallContainer');

// Download template
document.getElementById('btnTemplate').addEventListener('click',()=>{
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([["RollNo","Name","SubjectCode","SubjectName","Year","Section"]]);
  XLSX.utils.book_append_sheet(wb,ws,"Template");
  XLSX.writeFile(wb,"SeatingTemplate.xlsx");
});

// Upload students
document.getElementById('fileInput').addEventListener('change',async e=>{
  const file=e.target.files[0]; if(!file) return;
  const data=await file.arrayBuffer(); const wb=XLSX.read(data);
  const sheet=wb.Sheets[wb.SheetNames[0]];
  students=XLSX.utils.sheet_to_json(sheet);
  alert(`Loaded ${students.length} students`);
});

// Add hall
function addHall(){
  hallCounter++;
  const div=document.createElement('div');
  div.className='hall-config';
  div.id=`hall_${hallCounter}`;
  div.innerHTML=`
    <h3>Hall ${hallCounter}</h3>
    Rows:<input type="number" id="hall_rows_${hallCounter}" value="6" style="width:60px">
    Cols:<input type="number" id="hall_cols_${hallCounter}" value="6" style="width:60px">
    I:<input type="number" id="hall_I_${hallCounter}" value="0" style="width:50px">
    II:<input type="number" id="hall_II_${hallCounter}" value="0" style="width:50px">
    III:<input type="number" id="hall_III_${hallCounter}" value="0" style="width:50px">
    IV:<input type="number" id="hall_IV_${hallCounter}" value="0" style="width:50px">
  `;
  hallContainer.appendChild(div);
  halls.push({id:hallCounter});
}

function removeLastHall(){
  if(halls.length){ hallContainer.removeChild(hallContainer.lastChild); halls.pop(); }
}

// Seat ID
function seatId(c,r){ return String.fromCharCode(65+r)+(c+1); }

// Auto allocate students with no same subject/year left or right
function allocateToHall(stuList,h){
  const rows=+document.getElementById(`hall_rows_${h.id}`).value;
  const cols=+document.getElementById(`hall_cols_${h.id}`).value;
  const counts={I:+document.getElementById(`hall_I_${h.id}`).value,
                II:+document.getElementById(`hall_II_${h.id}`).value,
                III:+document.getElementById(`hall_III_${h.id}`).value,
                IV:+document.getElementById(`hall_IV_${h.id}`).value};
  const seats=Array.from({length:rows},()=>Array(cols).fill(null));
  const pool=stuList.slice();
  pool.sort(()=>Math.random()-0.5);

  const yearPool={I:[],II:[],III:[],IV:[]};
  pool.forEach(s=>{ if(yearPool[s.Year]) yearPool[s.Year].push(s); });

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      let placed=null;
      const left=c>0?seats[r][c-1]:null;

      for(const yr of ['I','II','III','IV']){
        if(counts[yr]>0 && yearPool[yr].length){
          let idx=yearPool[yr].findIndex(s=>!left||(s.SubjectCode!==left.SubjectCode && s.Year!==left.Year));
          if(idx===-1) idx=0;
          placed=yearPool[yr].splice(idx,1)[0];
          counts[yr]--; break;
        }
      }
      if(!placed && pool.length){
        let idx=pool.findIndex(s=>!left||(s.SubjectCode!==left.SubjectCode && s.Year!==left.Year));
        if(idx===-1) idx=0; placed=pool.splice(idx,1)[0];
      }
      seats[r][c]=placed;
    }
  }
  const assigned=[]; 
  for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) 
    assigned.push({row:r,col:c,student:seats[r][c],SeatNo:seatId(c,r)});
  return assigned;
}

// Render Preview
function renderPreview(){
  const preview=document.getElementById('preview'); preview.innerHTML='';
  let assignedCount=0, remainingCount=students.length;
  halls.forEach(h=>{
    const assigned=allocateToHall(students,h);
    assignedCount+=assigned.filter(a=>a.student).length;
    remainingCount=students.length-assignedCount;
    const rows=+document.getElementById(`hall_rows_${h.id}`).value;
    const cols=+document.getElementById(`hall_cols_${h.id}`).value;
    const mapDiv=document.createElement('div');
    mapDiv.className='seatmap';
    mapDiv.innerHTML=`<strong>Hall ${h.id}</strong>`;
    for(let r=0;r<rows;r++){
      const rowDiv=document.createElement('div'); rowDiv.className='seat-row';
      const label=document.createElement('div'); label.className='row-label'; label.textContent=r+1;
      rowDiv.appendChild(label);
      for(let c=0;c<cols;c++){
        const s=assigned.find(x=>x.row===r&&x.col===c);
        const div=document.createElement('div');
        div.className='seat';
        if(s.student){ 
          div.textContent=s.SeatNo;
          div.classList.add(s.student.Year);
          div.setAttribute('data-year',s.student.Year);
          div.setAttribute('data-name',s.student.Name);
          div.setAttribute('data-subject',s.student.SubjectCode);
          div.title=`${s.student.Name}\n${s.student.SubjectName}\n${s.student.SubjectCode}`;
        } else div.classList.add('empty');
        div.draggable=true;
        div.addEventListener('dragstart',dragStart);
        div.addEventListener('dragover',dragOver);
        div.addEventListener('drop',drop);
        rowDiv.appendChild(div);
      }
      mapDiv.appendChild(rowDiv);
    }
    preview.appendChild(mapDiv);
  });
  document.getElementById('assignCounter').textContent=`Assigned: ${assignedCount} | Unassigned: ${remainingCount}`;
}

// Drag and Drop
let dragSrc=null;
function dragStart(e){ dragSrc=e.target; }
function dragOver(e){ e.preventDefault(); }
function drop(e){
  e.preventDefault();
  if(!dragSrc || dragSrc===e.target) return;
  const tempText=dragSrc.textContent,tempYear=dragSrc.getAttribute('data-year'),
        tempName=dragSrc.getAttribute('data-name'),tempSub=dragSrc.getAttribute('data-subject');
  dragSrc.textContent=e.target.textContent;
  dragSrc.setAttribute('data-year',e.target.getAttribute('data-year'));
  dragSrc.setAttribute('data-name',e.target.getAttribute('data-name'));
  dragSrc.setAttribute('data-subject',e.target.getAttribute('data-subject'));
  e.target.textContent=tempText;
  e.target.setAttribute('data-year',tempYear);
  e.target.setAttribute('data-name',tempName);
  e.target.setAttribute('data-subject',tempSub);
  dragSrc=null;
}

// Excel Export
document.getElementById('btnGenerate').addEventListener('click',()=>{
  const date=document.getElementById('inpDate').value, dept=document.getElementById('inpDept').value, batch=document.getElementById('inpBatch').value;
  if(!date||!dept||!batch){ alert('Fill Date, Dept, Batch'); return; }
  const wb=XLSX.utils.book_new();
  document.querySelectorAll('.seatmap').forEach(hDiv=>{
    const hall=hDiv.querySelector('strong').textContent;
    const wsData=[['Date','Department','Batch','Hall No','Student Roll No','Name','Seating No','Subject Code','Subject','Year','Section']];
    hDiv.querySelectorAll('.seat-row').forEach((row,rowIdx)=>{
      row.querySelectorAll('.seat').forEach((seat,colIdx)=>{
        if(!seat.classList.contains('empty')){
          wsData.push([date,dept,batch,hall,seat.textContent,seat.getAttribute('data-name')||'',seatId(colIdx,rowIdx),seat.getAttribute('data-subject')||'',seat.getAttribute('data-subject')||'',seat.getAttribute('data-year')||'','']);
        }
      });
    });
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,hall);
  });
  XLSX.writeFile(wb,`${dept}_${batch}_${date}_Seating.xlsx`);
});

// Clear all
document.getElementById('btnClear').addEventListener('click',()=>{students=[];halls=[];hallCounter=0;hallContainer.innerHTML='';document.getElementById('preview').innerHTML='No file loaded.';document.getElementById('assignCounter').textContent='';});
document.getElementById('btnPreview').addEventListener('click',renderPreview);
document.getElementById('btnAddHall').addEventListener('click',addHall);
document.getElementById('btnRemoveLast').addEventListener('click',removeLastHall);
})();
</script>
</body>
</html>
