<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating ‚Äî Hall-wise Preview & Allocation</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0; padding: 10px;
    background: #f4f6fb;
  }
  h1 {text-align:center; color:#222;}
  .topbar {
    display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:10px;
  }
  input, select, button {
    padding:6px 10px; border-radius:6px; border:1px solid #ccc;
  }
  button {
    background:#0078d7; color:white; border:none; cursor:pointer;
  }
  button:hover {background:#005fa3;}
  #hallContainer {margin-top:20px;}
  .hall {
    background:white; padding:10px; margin-bottom:15px; border-radius:10px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  .hall-header {
    display:flex; justify-content:space-between; align-items:center;
  }
  .grid {
    display:grid; gap:3px; justify-content:center;
    margin-top:10px;
  }
  .seat {
    width:28px; height:28px; border-radius:4px; font-size:12px;
    display:flex; justify-content:center; align-items:center; cursor:grab;
  }
  .year1 {background:#6fa8dc;}
  .year2 {background:#93c47d;}
  .year3 {background:#f6b26b;}
  .year4 {background:#e06666;}
  .empty {background:#ccc;}
  .legend span {
    display:inline-block; width:15px; height:15px; margin-right:4px; border-radius:3px;
  }
  .preview-area {margin-top:20px;}
  .hidden {display:none;}
  @media(max-width:600px){
    .grid{transform:scale(0.9);}
  }
</style>
</head>
<body>

<h1>üéì Exam Seating Arrangement</h1>

<div class="topbar">
  <input type="date" id="examDate">
  <select id="department">
    <option value="">Select Department</option>
    <option value="CSE">CSE</option>
    <option value="ECE">ECE</option>
    <option value="EEE">EEE</option>
    <option value="BT">BT</option>
  </select>
  <select id="batch">
    <option value="">Select Batch</option>
    <option value="FN">FN</option>
    <option value="AN">AN</option>
  </select>
  <button onclick="downloadTemplate()">‚¨áÔ∏è Download Template</button>
  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
  <button onclick="addHall()">‚ûï Add Hall</button>
  <button onclick="generatePreview()">üëÅÔ∏è Preview</button>
  <button onclick="downloadExcel()">üì• Download Excel</button>
</div>

<div class="legend" style="text-align:center;">
  <span style="background:#6fa8dc"></span> I Year
  <span style="background:#93c47d"></span> II Year
  <span style="background:#f6b26b"></span> III Year
  <span style="background:#e06666"></span> IV Year
</div>

<div id="hallContainer"></div>
<div id="preview" class="preview-area"></div>

<script>
let students = [];
let halls = [];

function downloadTemplate(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([
    ["Roll No","Name","Subject Code","Subject","Year","Section"],
    ["","","","","",""]
  ]);
  XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "Exam_Template.xlsx");
}

document.getElementById('fileInput').addEventListener('change', handleFile);

function handleFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    students = XLSX.utils.sheet_to_json(ws);
    alert("‚úÖ Student data loaded successfully!");
  };
  reader.readAsArrayBuffer(file);
}

function addHall(){
  const hall = {
    name: "Hall_" + (halls.length+1),
    rows: 6,
    cols: 6,
    yearCount: {y1:0, y2:0, y3:0, y4:0}
  };
  halls.push(hall);
  renderHalls();
}

function renderHalls(){
  const container = document.getElementById('hallContainer');
  container.innerHTML = '';
  halls.forEach((h, i)=>{
    container.innerHTML += `
      <div class="hall">
        <div class="hall-header">
          <input value="${h.name}" onchange="halls[${i}].name=this.value">
          <div>
            Rows: <input type="number" value="${h.rows}" min="1" max="20" onchange="halls[${i}].rows=this.value">
            Cols: <input type="number" value="${h.cols}" min="1" max="20" onchange="halls[${i}].cols=this.value">
          </div>
          <button onclick="removeHall(${i})">‚ùå</button>
        </div>
        <div>
          <small>I:<input type="number" style="width:50px" value="${h.yearCount.y1}" onchange="halls[${i}].yearCount.y1=this.value"> 
          II:<input type="number" style="width:50px" value="${h.yearCount.y2}" onchange="halls[${i}].yearCount.y2=this.value"> 
          III:<input type="number" style="width:50px" value="${h.yearCount.y3}" onchange="halls[${i}].yearCount.y3=this.value"> 
          IV:<input type="number" style="width:50px" value="${h.yearCount.y4}" onchange="halls[${i}].yearCount.y4=this.value"></small>
        </div>
      </div>
    `;
  });
}

function removeHall(i){ halls.splice(i,1); renderHalls(); }

function generatePreview(){
  if(students.length==0){alert("Please upload student data first."); return;}
  const previewDiv = document.getElementById('preview');
  previewDiv.innerHTML = '';
  let studentIndex = 0;

  halls.forEach(h=>{
    const totalSeats = h.rows * h.cols;
    const grid = Array(h.rows).fill(0).map(()=>Array(h.cols).fill(null));

    for(let r=0;r<h.rows;r++){
      for(let c=0;c<h.cols;c++){
        let placed=false, tryCount=0;
        while(!placed && tryCount<students.length){
          const st = students[studentIndex % students.length];
          if(!conflict(grid, r, c, st)){
            grid[r][c]=st;
            studentIndex++;
            placed=true;
          } else {
            studentIndex++;
            tryCount++;
          }
        }
      }
    }

    const gridDiv = document.createElement('div');
    gridDiv.className='grid';
    gridDiv.style.gridTemplateColumns = `repeat(${h.cols}, 30px)`;
    grid.forEach(row=>{
      row.forEach(st=>{
        const seat = document.createElement('div');
        if(st){
          seat.className = 'seat year'+st.Year;
          seat.title = `${st.Roll_No}\n${st.Subject_Code}`;
          seat.draggable = true;
          seat.ondragstart = drag;
          seat.ondrop = drop;
          seat.ondragover = allowDrop;
          seat.innerText = st.Year;
        } else {
          seat.className='seat empty';
        }
        gridDiv.appendChild(seat);
      });
    });

    const hallBox = document.createElement('div');
    hallBox.className='hall';
    hallBox.innerHTML = `<div class='hall-header'><strong>${h.name}</strong></div>`;
    hallBox.appendChild(gridDiv);
    previewDiv.appendChild(hallBox);
  });
}

function conflict(grid, r, c, st){
  const dirs = [[0,-1],[0,1]];
  for(const [dr,dc] of dirs){
    const nr=r+dr, nc=c+dc;
    if(nr>=0 && nr<grid.length && nc>=0 && nc<grid[0].length){
      const n=grid[nr][nc];
      if(n && (n.Subject_Code===st.Subject_Code || n.Year===st.Year))
        return true;
    }
  }
  return false;
}

function allowDrop(ev){ev.preventDefault();}
function drag(ev){ev.dataTransfer.setData("text", ev.target.title);}
function drop(ev){
  ev.preventDefault();
  const data = ev.dataTransfer.getData("text");
  const srcStudent = students.find(s => s.Roll_No === data.split('\n')[0]);
  if(!srcStudent) return;
  const target = ev.target;
  if(!target.classList.contains('seat')) return;
  const oldTitle = target.title;
  const tgtStudent = students.find(s => s.Roll_No === oldTitle.split('\n')[0]);
  if(tgtStudent){
    // swap
    const tmp = {...srcStudent};
    Object.assign(srcStudent, tgtStudent);
    Object.assign(tgtStudent, tmp);
  }
  generatePreview();
}

function downloadExcel(){
  const date = document.getElementById('examDate').value;
  const dept = document.getElementById('department').value;
  const batch = document.getElementById('batch').value;
  if(!date||!dept||!batch){alert("Please fill date, dept, batch.");return;}

  let out = [["Date","Department","Batch","Hall No","Student Roll No","Name","Seating No","Subject Code","Subject","Year","Section"]];
  let seatNo=1;
  halls.forEach(h=>{
    for(let r=0;r<h.rows;r++){
      for(let c=0;c<h.cols;c++){
        const idx = (r*h.cols)+c;
        const st = students[idx % students.length];
        out.push([date,dept,batch,h.name,st.Roll_No,st.Name,seatNo++,st.Subject_Code,st.Subject,st.Year,st.Section]);
      }
    }
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(out);
  XLSX.utils.book_append_sheet(wb, ws, "Seating");
  XLSX.writeFile(wb, "Exam_Seating.xlsx");
}
</script>
</body>
</html>
