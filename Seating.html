<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating ‚Äî Preview & Allocation</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    margin: 0; padding: 10px;
    background: #f4f6fb;
  }
  h1 {text-align:center; color:#222;}
  .topbar {
    display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:10px;
  }
  input, select, button {
    padding:6px 10px; border-radius:6px; border:1px solid #ccc;
  }
  button {
    background:#0078d7; color:white; border:none; cursor:pointer;
  }
  button:hover {background:#005fa3;}
  #hallContainer {margin-top:10px;}
  .hall {
    background:white; padding:10px; margin-bottom:15px; border-radius:10px;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  .hall-header {
    display:flex; justify-content:space-between; align-items:center;
    flex-wrap:wrap;
  }
  .grid {
    display:grid; gap:4px; justify-content:center;
    margin-top:10px;
  }
  .seat {
    width:90px; height:70px; border-radius:6px; font-size:11px;
    display:flex; justify-content:center; align-items:center;
    flex-direction:column; cursor:grab; text-align:center;
    color:#fff; font-weight:500;
  }
  .year1 {background:#6fa8dc;}
  .year2 {background:#93c47d;}
  .year3 {background:#f6b26b;}
  .year4 {background:#e06666;}
  .empty {background:#ccc;}
  .legend span {
    display:inline-block; width:15px; height:15px; margin-right:4px; border-radius:3px;
  }
  .preview-area {margin-top:20px;}
  @media(max-width:600px){
    .seat {width:70px; height:60px; font-size:10px;}
  }
</style>
</head>
<body>

<h1>üéì Exam Seating Arrangement</h1>

<div class="topbar">
  <input type="date" id="examDate">
  <select id="department">
    <option value="">Select Department</option>
    <option value="CSE">CSE</option>
    <option value="ECE">ECE</option>
    <option value="EEE">EEE</option>
    <option value="BT">BT</option>
  </select>
  <select id="batch">
    <option value="">Select Batch</option>
    <option value="FN">FN</option>
    <option value="AN">AN</option>
  </select>
  <button onclick="downloadTemplate()">‚¨áÔ∏è Download Template</button>
  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
  <button onclick="addHall()">‚ûï Add Hall</button>
  <button onclick="generatePreview()">üëÅÔ∏è Preview</button>
  <button onclick="downloadExcel()">üì• Download Excel</button>
</div>

<div class="legend" style="text-align:center; margin-bottom:8px;">
  <span style="background:#6fa8dc"></span> I Year
  <span style="background:#93c47d"></span> II Year
  <span style="background:#f6b26b"></span> III Year
  <span style="background:#e06666"></span> IV Year
</div>

<div id="hallContainer"></div>
<div id="preview" class="preview-area"></div>

<script>
let students = [];
let halls = [];

// ===== TEMPLATE DOWNLOAD =====
function downloadTemplate(){
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet([
    ["Roll_No","Name","Subject_Code","Subject","Year","Section"],
    ["21CSE001","John","CS101","DS","1","A"]
  ]);
  XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, "Exam_Template.xlsx");
}

// ===== FILE UPLOAD =====
document.getElementById('fileInput').addEventListener('change', handleFile);
function handleFile(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, {type:'array'});
    const ws = wb.Sheets[wb.SheetNames[0]];
    students = XLSX.utils.sheet_to_json(ws);
    alert("‚úÖ Student data loaded successfully!");
  };
  reader.readAsArrayBuffer(file);
}

// ===== HALL ADD / REMOVE =====
function addHall(){
  halls.push({
    name: "Hall_" + (halls.length+1),
    rows: 4,
    cols: 6,
    yearCount: {y1:0, y2:0, y3:0, y4:0}
  });
  renderHalls();
}

function renderHalls(){
  const container = document.getElementById('hallContainer');
  container.innerHTML = '';
  halls.forEach((h, i)=>{
    container.innerHTML += `
      <div class="hall">
        <div class="hall-header">
          <input value="${h.name}" onchange="halls[${i}].name=this.value" style="font-weight:600;">
          <div>
            Rows: <input type="number" value="${h.rows}" min="1" max="20" onchange="halls[${i}].rows=this.value">
            Cols: <input type="number" value="${h.cols}" min="1" max="20" onchange="halls[${i}].cols=this.value">
          </div>
          <button onclick="removeHall(${i})">‚ùå</button>
        </div>
        <div>
          <small>
            I:<input type="number" style="width:40px" value="${h.yearCount.y1}" onchange="halls[${i}].yearCount.y1=this.value">
            II:<input type="number" style="width:40px" value="${h.yearCount.y2}" onchange="halls[${i}].yearCount.y2=this.value">
            III:<input type="number" style="width:40px" value="${h.yearCount.y3}" onchange="halls[${i}].yearCount.y3=this.value">
            IV:<input type="number" style="width:40px" value="${h.yearCount.y4}" onchange="halls[${i}].yearCount.y4=this.value">
          </small>
        </div>
      </div>`;
  });
}
function removeHall(i){halls.splice(i,1); renderHalls();}

// ===== PREVIEW GENERATION =====
function generatePreview(){
  if(students.length==0){alert("Please upload student data first."); return;}
  const previewDiv = document.getElementById('preview');
  previewDiv.innerHTML = '';

  let sIndex = 0;

  halls.forEach(h=>{
    const grid = Array.from({length:h.rows},()=>Array(h.cols).fill(null));

    for(let r=0;r<h.rows;r++){
      for(let c=0;c<h.cols;c++){
        let placed=false, tries=0;
        while(!placed && tries<students.length){
          const st = students[sIndex % students.length];
          if(!conflict(grid, r, c, st)){
            grid[r][c]=st;
            placed=true;
            sIndex++;
          } else {sIndex++; tries++;}
        }
      }
    }

    const gridDiv = document.createElement('div');
    gridDiv.className='grid';
    gridDiv.style.gridTemplateColumns = `repeat(${h.cols}, 95px)`;

    grid.forEach(row=>{
      row.forEach(st=>{
        const seat=document.createElement('div');
        if(st){
          seat.className='seat year'+st.Year;
          seat.draggable=true;
          seat.innerHTML=`<b>${st.Roll_No}</b><br>Y${st.Year} | ${st.Subject_Code}`;
          seat.dataset.roll=st.Roll_No;
          seat.addEventListener('dragstart',drag);
          seat.addEventListener('drop',drop);
          seat.addEventListener('dragover',allowDrop);
        }else{
          seat.className='seat empty';
          seat.innerHTML='--';
        }
        gridDiv.appendChild(seat);
      });
    });

    const hallBox=document.createElement('div');
    hallBox.className='hall';
    hallBox.innerHTML=`<div class='hall-header'><strong>${h.name}</strong></div>`;
    hallBox.appendChild(gridDiv);
    previewDiv.appendChild(hallBox);
  });
}

function conflict(grid, r, c, st){
  const dirs=[[0,-1],[0,1]];
  for(const [dr,dc] of dirs){
    const nr=r+dr, nc=c+dc;
    if(nr>=0&&nr<grid.length&&nc>=0&&nc<grid[0].length){
      const n=grid[nr][nc];
      if(n && (n.Subject_Code===st.Subject_Code || n.Year===st.Year)) return true;
    }
  }
  return false;
}

// ===== DRAG / DROP =====
function allowDrop(e){e.preventDefault();}
function drag(e){e.dataTransfer.setData("text", e.target.dataset.roll);}
function drop(e){
  e.preventDefault();
  const rollFrom=e.dataTransfer.getData("text");
  const rollTo=e.target.dataset.roll;
  const s1=students.find(s=>s.Roll_No===rollFrom);
  const s2=students.find(s=>s.Roll_No===rollTo);
  if(s1 && s2){
    const tmp={...s1};
    Object.assign(s1,s2);
    Object.assign(s2,tmp);
    generatePreview();
  }
}

// ===== EXCEL DOWNLOAD =====
function downloadExcel(){
  const date=document.getElementById('examDate').value;
  const dept=document.getElementById('department').value;
  const batch=document.getElementById('batch').value;
  if(!date||!dept||!batch){alert("Please fill date, dept, and batch");return;}

  let out=[["Date","Department","Batch","Hall No","Student Roll No","Name","Seating No","Subject Code","Subject","Year","Section"]];
  let seatNo=1;
  halls.forEach(h=>{
    for(let r=0;r<h.rows;r++){
      for(let c=0;c<h.cols;c++){
        const st=students[(r*h.cols)+c % students.length];
        out.push([date,dept,batch,h.name,st.Roll_No,st.Name,seatNo++,st.Subject_Code,st.Subject,st.Year,st.Section]);
      }
    }
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(out);
  XLSX.utils.book_append_sheet(wb,ws,"Seating");
  XLSX.writeFile(wb,"Exam_Seating.xlsx");
}
</script>
</body>
</html>
