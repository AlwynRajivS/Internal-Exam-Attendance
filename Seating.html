<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Exam Seating — Multi‑Hall Allotment</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
:root {
  --year1:#3b82f6; --year2:#10b981; --year3:#f59e0b; --year4:#ef4444;
  --accent:#06b6d4; --accent2:#7c3aed; --muted:#94a3b8; --seat-bg:#f0f9ff; --seat-hover:#d1f0ff;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Poppins,system-ui,Arial;background:linear-gradient(180deg,#e6f9ff 0%, #f7f5ff 100%);color:#052029;padding:12px;}
.wrap{max-width:1200px;margin:0 auto;}
header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;}
.logo{width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;}
h1{font-size:20px;margin:0;}
p.lead{color:#0b5564;font-size:13px;}
.main{display:grid;grid-template-columns:380px 1fr;gap:12px;}
.card{background:white;border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(13,38,52,0.06);}
label{display:block;font-size:12px;color:#073741;margin-top:6px;}
select,input[type=text],input[type=date],input[type=number],button{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(3,37,45,0.06);font-size:13px;}
.row{display:flex;gap:6px;}
.small{font-size:11px;color:var(--muted);}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021;cursor:pointer;border:none;padding:8px;border-radius:6px;font-weight:600;transition:0.3s;}
.btn:hover{opacity:0.9;}
.btn.ghost{background:transparent;border:1px solid rgba(3,37,45,0.06);color:#073741;}
.hall-list{display:flex;flex-direction:column;gap:6px;}
.hall-item{display:grid;grid-template-columns:1fr 50px 50px 36px;gap:6px;align-items:center;}
.hall-item input{width:100%;}
.add-hall{display:flex;gap:6px;margin-top:6px;}
.preview-area{display:grid;gap:8px;}
.seatmap{display:flex;flex-direction:column;gap:6px;padding:6px;border-radius:10px;background:linear-gradient(180deg, #f8fcff, #fbf7ff);}
.seat-row{display:flex;gap:4px;align-items:center;}
.row-label{width:20px;text-align:center;color:var(--muted);font-weight:600;}
.seat{min-width:48px;height:40px;border-radius:6px;background:var(--seat-bg);border:1px solid #e6eef3;display:flex;align-items:center;justify-content:center;flex-direction:column;font-size:11px;position:relative;transition:0.3s;touch-action: none;}
.seat:hover{background:var(--seat-hover);}
.seat.empty{opacity:0.3;}
table{width:100%;border-collapse:collapse;margin-top:6px;font-size:12px;}
th,td{padding:6px;border:1px solid #e6eef3;text-align:left;font-size:12px;}
th{background:#edf7fb;}
.controls{display:flex;gap:6px;align-items:center;margin-top:6px;flex-wrap:wrap;}
footer{margin-top:12px;color:#6a7d86;font-size:12px;}
.tooltip{position:absolute;background:#021;color:white;font-size:10px;padding:2px 4px;border-radius:4px;top:-24px;left:50%;transform:translateX(-50%);opacity:0;pointer-events:none;transition:0.2s;}
.seat:hover .tooltip{opacity:1;}
@media (max-width:980px){.main{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div class="logo">ES</div>
  <div>
    <h1>Exam Seating — Multi‑Hall Allotment</h1>
    <p class="lead">Upload student sheet, define halls & rows/columns, preview, drag & drop, and download Excel.</p>
  </div>
</header>

<div class="main">
<div>
  <div class="card">
    <label>Date</label>
    <input type="date" id="inpDate">

    <label>Department</label>
    <select id="inpDept">
      <option value="">-- Select --</option>
      <option value="CSE">CSE</option>
      <option value="ECE">ECE</option>
      <option value="BT">BT</option>
    </select>

    <label>Batch</label>
    <select id="inpBatch">
      <option value="">-- Select --</option>
      <option value="FN">FN</option>
      <option value="AN">AN</option>
    </select>

    <label>Upload Student File (.xlsx / .csv)</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
    <div class="small">Columns: <code>Roll No, Name, Year, Section, Subject Code, Subject</code></div>
    <div class="controls">
      <button class="btn" id="btnTemplate">Download Template</button>
      <button class="btn ghost" id="btnPreviewSample">Show Sample</button>
    </div>

    <hr style="margin:8px 0">
    <label>Halls</label>
    <div class="hall-list" id="hallList"></div>
    <div class="add-hall">
      <button class="btn ghost" id="btnAddHall">+ Add Hall</button>
      <button class="btn" id="btnRemoveLast">Remove Last</button>
    </div>

    <hr style="margin:8px 0">
    <label>Seating Pattern</label>
    <select id="pattern">
      <option value="row">Row-wise</option>
      <option value="col">Column-wise</option>
      <option value="snake">Snake</option>
      <option value="alternate">Alternate Row</option>
      <option value="block">Block</option>
    </select>
    <label style="margin-top:4px"><input type="checkbox" id="randomize" checked/> Randomize students before seating</label>

    <div class="controls">
      <button class="btn" id="btnGenerate">Preview & Download</button>
      <button class="btn ghost" id="btnClear">Clear</button>
    </div>

    <div class="small" style="margin-top:4px">Legend: I Year Blue, II Year Green, III Year Orange, IV Year Red</div>
  </div>
</div>

<div>
  <div class="card preview-area">
    <div id="messages">No file loaded.</div>
    <div id="preview" style="min-height:220px"></div>
  </div>
</div>
</div>

<footer>Mobile friendly. Drag & drop supported. Ensure xlsx.full.min.js is included.</footer>
</div>

<script>
(function(){
let students=[], halls=[], hallCounter=0;

// Normalize uploaded data
function normalizeRow(r){
  const map={};
  for(const k in r) if(Object.prototype.hasOwnProperty.call(r,k)) map[k.trim().toLowerCase()] = r[k];
  return {
    RollNo:map['roll no']||map['rollno']||'',
    Name:map['name']||map['name of the student']||'',
    Year:map['year']||'',
    Section:map['section']||'',
    SubjectCode:map['subject code']||map['subjectcode']||'',
    Subject:map['subject']||map['subject name']||''
  };
}

// Render hall list inputs
function renderHallList(){
  const container=document.getElementById('hallList'); container.innerHTML='';
  halls.forEach(h=>{
    const div=document.createElement('div'); div.className='hall-item';
    div.innerHTML=`
      <input type='text' id='hall_name_${h.id}' value='${h.name}' placeholder='Hall Name'>
      <input type='number' id='hall_rows_${h.id}' value='${h.rows}' min='1' placeholder='Rows'>
      <input type='number' id='hall_cols_${h.id}' value='${h.cols}' min='1' placeholder='Cols'>
      <button type='button' data-remove='${h.id}' class='remove-btn' style='background:#ef4444;color:white;border:none;border-radius:6px;padding:4px'>×</button>
    `;
    container.appendChild(div);
  });
  container.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.getAttribute('data-remove'));
      halls=halls.filter(x=>x.id!==id); renderHallList();
    });
  });
}

function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6){
  hallCounter++;
  halls.push({id:hallCounter,name,rows,cols});
  renderHallList();
}

function removeLastHall(){ if(halls.length){ halls.pop(); hallCounter--; renderHallList(); } }

// Parse CSV
function parseCSV(text){
  const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(!lines.length) return {rows:[]};
  const sep=lines[0].includes(',') ? ',' : '\t';
  const headers=lines[0].split(sep).map(h=>h.trim());
  const rows=lines.slice(1).map(l=>{
    const cols=l.split(sep).map(c=>c.trim()); const obj={};
    headers.forEach((h,i)=> obj[h]=cols[i]||''); return obj;
  });
  return {headers,rows};
}

function showMessage(msg){ document.getElementById('messages').innerHTML=`<strong>${msg}</strong>`; }

function renderSampleTable(n=6){
  const preview=document.getElementById('preview'); preview.innerHTML='';
  if(!students.length){ preview.innerHTML='<div class="small">No data</div>'; return; }
  const tbl=document.createElement('table');
  const ths=['Roll No','Name','Year','Section','Subject Code','Subject'];
  const thead=document.createElement('thead'); thead.innerHTML='<tr>'+ths.map(t=>`<th>${t}</th>`).join('')+'</tr>';
  tbl.appendChild(thead);
  const tbody=document.createElement('tbody');
  students.slice(0,n).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.RollNo}</td><td>${s.Name}</td><td>${s.Year}</td><td>${s.Section}</td><td>${s.SubjectCode}</td><td>${s.Subject}</td>`;
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);
  preview.appendChild(tbl);
}

// Template Download
document.getElementById('btnTemplate').addEventListener('click',()=>{
  const headers=['Roll No','Name','Year','Section','Subject Code','Subject'];
  const ws=XLSX.utils.aoa_to_sheet([headers,['12345','Student One','1','A','CS101','Networks']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Template');
  XLSX.writeFile(wb,'Seating_Template.xlsx');
});

// Show sample table
document.getElementById('btnPreviewSample').addEventListener('click',()=>{ renderSampleTable(12); });

// File Upload
document.getElementById('fileInput').addEventListener('change', async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name.toLowerCase();
  if(name.endsWith('.csv')){
    const text=await f.text(); const parsed=parseCSV(text);
    students=parsed.rows.map(normalizeRow); showMessage(`Loaded ${students.length} records from CSV`); renderSampleTable(5); return;
  }
  try{
    const data=await f.arrayBuffer();
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const arr=XLSX.utils.sheet_to_json(ws,{defval:''});
    students=arr.map(normalizeRow); showMessage(`Loaded ${students.length} records from Excel`); renderSampleTable(8);
  }catch(err){ showMessage('Failed to read file: '+err.message); }
});

// Drag & Drop Helpers
function enableDragDrop(seatDiv){
  seatDiv.draggable=true;
  seatDiv.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain',seatDiv.dataset.index); });
  seatDiv.addEventListener('dragover',(e)=>e.preventDefault());
  seatDiv.addEventListener('drop',(e)=>{
    e.preventDefault();
    const fromIndex=e.dataTransfer.getData('text/plain');
    const toIndex=seatDiv.dataset.index;
    const temp=assignedSeats[fromIndex].student;
    assignedSeats[fromIndex].student=assignedSeats[toIndex].student;
    assignedSeats[toIndex].student=temp;
    renderPreview();
  });
}

// Generate seat ID
function seatId(col,row){ return `${String.fromCharCode(65+col)}${row+1}`; }

// Build order
function buildSeatOrder(rows,cols,pattern){
  const order=[];
  if(pattern==='row'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) order.push({r,c}); }
  else if(pattern==='col'){ for(let c=0;c<cols;c++) for(let r=0;r<rows;r++) order.push({r,c}); }
  else if(pattern==='snake'){ for(let r=0;r<rows;r++){ if(r%2===0) for(let c=0;c<cols;c++) order.push({r,c}); else for(let c=cols-1;c>=0;c--) order.push({r,c}); } }
  else if(pattern==='alternate'){ for(let r=0;r<rows;r++) for(let c=0;c<cols;c+=2) order.push({r,c}); for(let r=0;r<rows;r++) for(let c=1;c<cols;c+=2) order.push({r,c}); }
  else if(pattern==='block'){ const br=Math.max(1,Math.floor(rows/2)),bc=Math.max(1,Math.floor(cols/2));
    for(let r0=0;r0<rows;r0+=br) for(let c0=0;c0<cols;c0+=bc) for(let r=r0;r<Math.min(rows,r0+br);r++) for(let c=c0;c<Math.min(cols,c0+bc);c++) order.push({r,c});
  }
  return order;
}

function allocateToHall(stuList, rows, cols, pattern, randomize=true){
  const seats=Array.from({length:rows},()=>Array.from({length:cols},()=>null));
  const order=buildSeatOrder(rows,cols,pattern);
  let pool=stuList.slice(); if(randomize) pool.sort(()=>Math.random()-0.5);
  for(const pos of order){
    if(!pool.length) break;
    const left=pos.c>0 ? seats[pos.r][pos.c-1] : null;
    let idx=pool.findIndex(s=>!left || (s.SubjectCode!==left.SubjectCode && s.Year!==left.Year));
    if(idx===-1) idx=0;
    seats[pos.r][pos.c]=pool.splice(idx,1)[0];
  }
  const assigned=[]; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) assigned.push({row:r,col:c,student:seats[r][c]});
  return {assigned,remaining:pool};
}

let assignedSeats=[];

function renderPreview(){
  const preview=document.getElementById('preview'); preview.innerHTML='';
  assignedSeats.forEach((s,i)=>{
    if(!s.seatDiv){
      const seatDiv=document.createElement('div'); seatDiv.className='seat'; seatDiv.dataset.index=i;
      seatDiv.innerHTML=`<div>${s.SeatNo}</div>${s.student?s.student.RollNo:''}`;
      const tooltip=document.createElement('div'); tooltip.className='tooltip';
      tooltip.innerHTML=s.student?s.student.Name+'<br>'+s.student.SubjectCode:'';
      seatDiv.appendChild(tooltip);
      enableDragDrop(seatDiv);
      s.seatDiv=seatDiv;
    }
    preview.appendChild(s.seatDiv);
    s.seatDiv.style.background = s.student?(
      s.student.Year=='1'? 'var(--year1)': s.student.Year=='2'? 'var(--year2)': s.student.Year=='3'? 'var(--year3)': 'var(--year4)'
    ): 'var(--seat-bg)';
    s.SeatNo = seatId(s.col,s.row);
    s.seatDiv.innerHTML=`<div>${s.SeatNo}</div>${s.student?s.student.RollNo:''}<div class="tooltip">${s.student?s.student.Name+'<br>'+s.student.SubjectCode:''}</div>`;
  });
}

// Generate & Download
document.getElementById('btnGenerate').addEventListener('click',()=>{
  const date=document.getElementById('inpDate').value,dept=document.getElementById('inpDept').value,batch=document.getElementById('inpBatch').value;
  if(!date||!dept||!batch){ alert('Date, Dept, and Batch required'); return;}
  assignedSeats=[]; let allRemaining=[];
  const pattern=document.getElementById('pattern').value;
  const randomize=document.getElementById('randomize').checked;
  halls.forEach(h=>{
    const rows=Number(document.getElementById(`hall_rows_${h.id}`).value);
    const cols=Number(document.getElementById(`hall_cols_${h.id}`).value);
    const {assigned,remaining}=allocateToHall(students,rows,cols,pattern,randomize);
    assigned.forEach(s=>{ s.Hall=h.name; s.Date=date; s.Department=dept; s.Batch=batch; });
    assignedSeats.push(...assigned);
    allRemaining.push(...remaining);
  });
  if(allRemaining.length) showMessage(`Some students unassigned: ${allRemaining.length}`);
  else showMessage(`All ${students.length} students assigned.`);
  renderPreview();

  // Excel Export
  const data=assignedSeats.map(s=>{
    return {
      Date:s.Date, Department:s.Department, Batch:s.Batch, "Hall No":s.Hall,
      "Student Roll No":s.student?s.student.RollNo:'',
      Name:s.student?s.student.Name:'',
      "Seating No":s.SeatNo,
      "Subject Code":s.student?s.student.SubjectCode:'',
      Subject:s.student?s.student.Subject:'',
      Year:s.student?s.student.Year:'',
      Section:s.student?s.student.Section||''
    };
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Seating');
  XLSX.writeFile(wb,`Seating_${dept}_${batch}_${date}.xlsx`);
});

// Add / Remove halls
document.getElementById('btnAddHall').addEventListener('click',()=>addHall());
document.getElementById('btnRemoveLast').addEventListener('click',()=>removeLastHall());

// Clear all
document.getElementById('btnClear').addEventListener('click',()=>{
  students=[]; halls=[]; hallCounter=0; assignedSeats=[]; renderHallList();
  document.getElementById('preview').innerHTML=''; document.getElementById('messages').innerHTML='Cleared';
});

})();
</script>
</body>
</html>
