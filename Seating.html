<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Seating Allotment</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Poppins,sans-serif;margin:0;padding:10px;background:#f0f8ff;color:#052029;}
h1{font-size:22px;margin-bottom:8px;}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 6px 24px rgba(13,38,52,0.06);}
input,select,button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px;width:100%;margin-top:4px;}
button{cursor:pointer;}
button.btn{background:linear-gradient(90deg,#06b6d4,#7c3aed);color:white;border:none;font-weight:600;}
button.btn:hover{opacity:0.9;}
button.ghost{background:transparent;border:1px solid #ccc;color:#073741;}
.hall-list{margin-top:8px;}
.hall-item{display:grid;grid-template-columns:1fr 60px 60px 36px 60px 60px 60px 60px;gap:6px;margin-bottom:6px;}
.seatmap{display:flex;flex-direction:column;gap:8px;background:#fdfdfd;padding:10px;border-radius:12px;overflow-x:auto;}
.seat-row{display:flex;gap:6px;}
.seat{min-width:50px;height:40px;border-radius:8px;background:#f0f9ff;border:1px solid #e6eef3;display:flex;align-items:center;justify-content:center;font-size:12px;position:relative;touch-action: none;}
.seat.I{background:#3b82f6;color:white;}
.seat.II{background:#10b981;color:white;}
.seat.III{background:#f97316;color:white;}
.seat.IV{background:#ef4444;color:white;}
.seat.empty{opacity:0.4;}
.row-label{width:30px;text-align:center;font-weight:600;color:#555;}
.controls{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
.counter{margin-top:6px;font-size:14px;font-weight:600;}
@media(max-width:800px){.seat{min-width:36px;height:32px;font-size:10px;}}
</style>
</head>
<body>
<h1>Exam Seating Allotment</h1>
<div class="card">
<label>Date</label>
<input type="date" id="inpDate">

<label>Department</label>
<select id="inpDept">
  <option value="">-- Select --</option>
  <option value="CSE">CSE</option>
  <option value="ECE">ECE</option>
  <option value="BT">BT</option>
</select>

<label>Batch</label>
<select id="inpBatch">
  <option value="">-- Select --</option>
  <option value="FN">FN</option>
  <option value="AN">AN</option>
</select>

<label>Upload Student File (.xlsx/.csv)</label>
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

<div class="controls">
<button class="btn" id="btnTemplate">Download Template</button>
</div>

<hr>

<label>Halls</label>
<div class="hall-list" id="hallList"></div>
<div class="controls">
<button class="ghost" id="btnAddHall">+ Add Hall</button>
<button class="ghost" id="btnRemoveLast">Remove Last</button>
</div>

<div class="controls">
<button class="btn" id="btnPreview">Preview Seating</button>
<button class="btn" id="btnGenerate">Generate & Download Excel</button>
<button class="ghost" id="btnClear">Clear All</button>
</div>
<div class="counter" id="assignCounter"></div>
</div>

<div class="card" id="previewContainer">
<h3>Preview</h3>
<div id="preview">No file loaded.</div>
</div>

<script>
let students=[], halls=[], hallCounter=0;

// Normalize uploaded row
function normalizeRow(r){
  const map={};
  for(const k in r) if(Object.prototype.hasOwnProperty.call(r,k)) map[k.trim().toLowerCase()]=r[k];
  return {
    RollNo: map['roll no']||'',
    Name: map['name of the student']||'',
    Year: map['year']||'',
    Section: map['section']||'',
    SubjectCode: map['subject code']||'',
    SubjectName: map['subject name']||''
  };
}

// Hall list render
function renderHallList(){
  const container=document.getElementById('hallList'); container.innerHTML='';
  halls.forEach(h=>{
    const div=document.createElement('div'); div.className='hall-item';
    div.innerHTML=`
      <input type='text' id='hall_name_${h.id}' value='${h.name}' placeholder='Hall Name'>
      <input type='number' id='hall_rows_${h.id}' value='${h.rows}' min='1' placeholder='Rows'>
      <input type='number' id='hall_cols_${h.id}' value='${h.cols}' min='1' placeholder='Cols'>
      <input type='number' id='hall_I_${h.id}' value='${h.I||""}' min='0' placeholder='I Year'>
      <input type='number' id='hall_II_${h.id}' value='${h.II||""}' min='0' placeholder='II Year'>
      <input type='number' id='hall_III_${h.id}' value='${h.III||""}' min='0' placeholder='III Year'>
      <input type='number' id='hall_IV_${h.id}' value='${h.IV||""}' min='0' placeholder='IV Year'>
      <button type='button' data-remove='${h.id}' class='remove-btn'>Ã—</button>
    `;
    container.appendChild(div);
  });
  container.querySelectorAll('.remove-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=Number(btn.getAttribute('data-remove'));
      halls=halls.filter(x=>x.id!==id);
      renderHallList();
    });
  });
}

// add/remove hall
function addHall(name=`Hall ${hallCounter+1}`, rows=6, cols=6){
  hallCounter++;
  halls.push({id:hallCounter,name,rows,cols});
  renderHallList();
}
function removeLastHall(){ if(halls.length){ halls.pop(); hallCounter--; renderHallList(); } }

// template download
document.getElementById('btnTemplate').addEventListener('click',()=>{
  const headers=['Roll No','Name of the Student','Year','Section','Subject Code','Subject Name'];
  const ws=XLSX.utils.aoa_to_sheet([headers,['12345','Student One','I','A','CS101','Networks']]);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Template');
  XLSX.writeFile(wb,'Seating_Template.xlsx');
});

// file upload
document.getElementById('fileInput').addEventListener('change',async(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const name=f.name.toLowerCase();
  try{
    if(name.endsWith('.csv')){
      const text=await f.text();
      const lines=text.split(/\r?\n/).filter(l=>l.trim());
      const headers=lines[0].split(',').map(h=>h.trim());
      students=lines.slice(1).map(l=>{
        const cols=l.split(',');
        const obj={};
        headers.forEach((h,i)=>obj[h]=cols[i]||'');
        return normalizeRow(obj);
      });
    }else{
      const data=await f.arrayBuffer();
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      students=XLSX.utils.sheet_to_json(ws,{defval:''}).map(normalizeRow);
    }
    alert(`Loaded ${students.length} students`);
  }catch(err){ alert('Error loading file: '+err.message); }
});

// seat helpers
function seatId(col,row){ return `${String.fromCharCode(65+col)}${row+1}`; }
function buildSeatOrder(rows,cols){ 
  const order=[]; for(let r=0;r<rows;r++) for(let c=0;c<cols;c++) order.push({r,c}); return order; 
}

// allocate to hall with manual year count
function allocateToHall(stuList,h){
  const rows=Number(document.getElementById(`hall_rows_${h.id}`).value);
  const cols=Number(document.getElementById(`hall_cols_${h.id}`).value);
  const countI=Number(document.getElementById(`hall_I_${h.id}`).value)||0;
  const countII=Number(document.getElementById(`hall_II_${h.id}`).value)||0;
  const countIII=Number(document.getElementById(`hall_III_${h.id}`).value)||0;
  const countIV=Number(document.getElementById(`hall_IV_${h.id}`).value)||0;
  const assigned=[];
  const remaining=[...stuList];
  const order=buildSeatOrder(rows,cols);
  // allocate manually per year
  const yearAlloc={I:countI,II:countII,III:countIII,IV:countIV};
  for(const y of ['I','II','III','IV']){
    let ycount=yearAlloc[y];
    if(ycount>0){
      for(const pos of order){
        if(!remaining.length) break;
        const idx=remaining.findIndex(s=>s.Year===y);
        if(idx===-1) break;
        const s=remaining.splice(idx,1)[0];
        assigned.push({...pos,student:s,SeatNo:seatId(pos.c,pos.r)});
        ycount--;
        if(ycount<=0) break;
      }
    }
  }
  // fill remaining automatically
  for(const pos of order){
    if(!remaining.length) break;
    if(assigned.find(a=>a.row===pos.r && a.col===pos.c)) continue;
    const s=remaining.shift();
    assigned.push({...pos,student:s,SeatNo:seatId(pos.c,pos.r)});
  }
  return {assigned,remaining};
}

// render preview
function renderPreview(){
  const preview=document.getElementById('preview'); preview.innerHTML='';
  let assignedCount=0; let remainingStudents=[...students];
  halls.forEach(h=>{
    const {assigned,remaining}=allocateToHall(remainingStudents,h);
    remainingStudents=remaining;
    assignedCount+=assigned.filter(a=>a.student).length;
    const mapDiv=document.createElement('div'); mapDiv.className='seatmap';
    mapDiv.innerHTML=`<strong>${h.name}</strong>`;
    const rows=Number(document.getElementById(`hall_rows_${h.id}`).value);
    const cols=Number(document.getElementById(`hall_cols_${h.id}`).value);
    for(let r=0;r<rows;r++){
      const rowDiv=document.createElement('div'); rowDiv.className='seat-row';
      const label=document.createElement('div'); label.className='row-label'; label.textContent=r+1;
      rowDiv.appendChild(label);
      for(let c=0;c<cols;c++){
        const s=assigned.find(x=>x.row===r && x.col===c);
        const seatDiv=document.createElement('div'); seatDiv.className='seat';
        if(s?.student){ seatDiv.classList.add(s.student.Year); seatDiv.textContent=s.SeatNo; seatDiv.title=`${s.student.Name}\n${s.student.SubjectCode}`; }
        else seatDiv.classList.add('empty'), seatDiv.textContent=seatId(c,r);
        seatDiv.draggable=true;
        seatDiv.addEventListener('dragstart',dragStart);
        seatDiv.addEventListener('dragover',dragOver);
        seatDiv.addEventListener('drop',drop);
        rowDiv.appendChild(seatDiv);
      }
      mapDiv.appendChild(rowDiv);
    }
    preview.appendChild(mapDiv);
  });
  document.getElementById('assignCounter').textContent=`Assigned: ${assignedCount} | Unassigned: ${remainingStudents.length}`;
}

// drag-drop
let dragSrc=null;
function dragStart(e){ dragSrc=e.target; }
function dragOver(e){ e.preventDefault(); }
function drop(e){ e.preventDefault(); if(dragSrc && dragSrc!==e.target){ const tmp=dragSrc.innerHTML; const tmpClass=dragSrc.className; dragSrc.innerHTML=e.target.innerHTML; dragSrc.className=e.target.className; e.target.innerHTML=tmp; e.target.className=tmpClass; } }

// buttons
document.getElementById('btnAddHall').addEventListener('click',()=>addHall());
document.getElementById('btnRemoveLast').addEventListener('click',()=>removeLastHall());
document.getElementById('btnClear').addEventListener('click',()=>{students=[]; halls=[]; hallCounter=0; renderHallList(); document.getElementById('preview').innerHTML='No file loaded.'; document.getElementById('assignCounter').textContent='';});
document.getElementById('btnPreview').addEventListener('click',renderPreview);
document.getElementById('btnGenerate').addEventListener('click',()=>{
  const date=document.getElementById('inpDate').value;
  const dept=document.getElementById('inpDept').value;
  const batch=document.getElementById('inpBatch').value;
  if(!date||!dept||!batch){ alert('Fill Date, Department, Batch'); return; }
  let allAssigned=[], remainingStudents=[...students];
  halls.forEach(h=>{
    const {assigned,remaining}=allocateToHall(remainingStudents,h);
    remainingStudents=remaining;
    assigned.forEach(a=>allAssigned.push({
      Date:date,Department:dept,Batch:batch,HallNo:h.name,StudentRollNo:a.student?a.student.RollNo:'',Name:a.student?a.student.Name:'',SeatingNo:a.SeatNo,SubjectCode:a.student?a.student.SubjectCode:'',Subject:a.student?a.student.SubjectName:'',Year:a.student?a.student.Year:'',Section:a.student?a.student.Section:''
    }));
  });
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(allAssigned);
  XLSX.utils.book_append_sheet(wb,ws,'Seating');
  XLSX.writeFile(wb,`Seating_${date}.xlsx`);
  alert('Excel generated!');
});

renderHallList();
</script>
</body>
</html>
