<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CoE Report & CSV Download</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">
<script src="common.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --primary: #4f46e5;
  --primary-dark: #4338ca;
  --primary-light: #6366f1;
  --accent: #06b6d4;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --bg-gradient-start: #f8fafc;
  --bg-gradient-end: #e0e7ff;
  --card-bg: #ffffff;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --border-color: #e2e8f0;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
  --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);
  --shadow-xl: 0 25px 50px -12px rgba(0,0,0,0.25);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:'Inter','Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;
  background:linear-gradient(135deg,var(--bg-gradient-start) 0%,var(--bg-gradient-end) 100%);
  color:var(--text-primary);padding:20px;min-height:100vh;line-height:1.6;
}
.card{
  background:var(--card-bg);border-radius:20px;max-width:1400px;margin:0 auto;
  padding:32px;box-shadow:var(--shadow-xl);border:1px solid rgba(255,255,255,0.8);
  backdrop-filter:blur(10px);animation:slideIn 0.5s ease-out;
}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.header-container{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px;margin-bottom:24px;}
.header-left{flex:1;}
h1{
  font-size:32px;font-weight:700;
  background:linear-gradient(135deg,var(--primary) 0%,var(--accent) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:8px;letter-spacing:-0.5px;
}
#welcome{color:var(--text-secondary);font-size:14px;font-weight:500;display:flex;align-items:center;gap:8px;}
#welcome::before{content:"üë§";font-size:16px;}
.header-buttons{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
.btn{
  background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
  color:#fff;padding:12px 20px;border-radius:12px;border:none;cursor:pointer;
  font-size:14px;font-weight:600;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  box-shadow:var(--shadow-md);display:inline-flex;align-items:center;gap:8px;
  position:relative;overflow:hidden;
}
.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:left 0.5s;}
.btn:hover::before{left:100%;}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 16px -4px rgba(79,70,229,0.4);}
.btn:active{transform:translateY(0);}
.btn-secondary{background:linear-gradient(135deg,#64748b 0%,#475569 100%);}
.btn-secondary:hover{box-shadow:0 8px 16px -4px rgba(100,116,139,0.4);}
.divider{height:1px;background:linear-gradient(90deg,transparent,var(--border-color),transparent);margin:24px 0;}
.filter-section{
  background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);
  border-radius:16px;padding:24px;margin-bottom:28px;
  border:1px solid var(--border-color);box-shadow:var(--shadow-sm);
}
.filter-header{display:flex;align-items:center;gap:10px;margin-bottom:20px;font-size:16px;font-weight:700;color:var(--text-primary);}
.filter-header::before{content:"üéØ";font-size:20px;}
.filter-bar{display:flex;flex-wrap:wrap;align-items:center;gap:12px;}
.filter-bar select,.filter-bar input{
  padding:12px 16px;border-radius:10px;border:2px solid var(--border-color);
  font-size:14px;font-weight:500;color:var(--text-primary);background:white;
  transition:all 0.3s ease;min-width:180px;
}
.filter-bar select:focus,.filter-bar input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.filter-bar select:hover,.filter-bar input:hover{border-color:var(--primary-light);}
.action-buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
.btn-load{background:linear-gradient(135deg,var(--success) 0%,#059669 100%);}
.btn-load:hover{box-shadow:0 8px 16px -4px rgba(16,185,129,0.4);}
.btn-csv{background:linear-gradient(135deg,var(--warning) 0%,#d97706 100%);}
.btn-csv:hover{box-shadow:0 8px 16px -4px rgba(245,158,11,0.4);}
.btn-pdf{background:linear-gradient(135deg,var(--danger) 0%,#dc2626 100%);}
.btn-pdf:hover{box-shadow:0 8px 16px -4px rgba(239,68,68,0.4);}
#reportTable{margin-top:28px;overflow:hidden;border-radius:16px;box-shadow:var(--shadow-lg);background:white;}
.table-container{overflow-x:auto;border-radius:16px;}
table{border-collapse:separate;border-spacing:0;width:100%;background:white;min-width:1000px;}
th,td{padding:16px 12px;text-align:left;font-size:14px;border-bottom:1px solid var(--border-color);}
th{
  background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
  color:white;font-weight:600;text-transform:uppercase;font-size:12px;
  letter-spacing:0.5px;position:sticky;top:0;z-index:10;white-space:nowrap;
}
th:first-child{border-top-left-radius:12px;}
th:last-child{border-top-right-radius:12px;}
tbody tr{transition:all 0.2s ease;}
tbody tr:hover{background:linear-gradient(90deg,rgba(79,70,229,0.05) 0%,rgba(6,182,212,0.05) 100%);transform:scale(1.01);box-shadow:var(--shadow-sm);}
tbody tr:nth-child(even){background:#f9fafb;}
tbody tr:nth-child(even):hover{background:linear-gradient(90deg,rgba(79,70,229,0.08) 0%,rgba(6,182,212,0.08) 100%);}
td{color:var(--text-primary);font-weight:500;}
td:first-child{font-weight:600;color:var(--primary);}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-secondary);}
.empty-state::before{content:"üìä";font-size:64px;display:block;margin-bottom:16px;}
.empty-state p{font-size:18px;font-weight:500;}
.loading{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:white;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.fade-in{animation:fadeIn 0.5s ease-in;}
.table-container::-webkit-scrollbar{height:8px;}
.table-container::-webkit-scrollbar-track{background:#f1f5f9;border-radius:10px;}
.table-container::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--primary) 0%,var(--accent) 100%);border-radius:10px;}
.table-container::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 100%);}
@media(max-width:768px){
  body{padding:12px;}
  .card{padding:20px;border-radius:16px;}
  h1{font-size:24px;}
  .header-container{flex-direction:column;align-items:stretch;}
  .header-buttons{justify-content:center;}
  .filter-bar{flex-direction:column;align-items:stretch;}
  .filter-bar select,.filter-bar input{width:100%;min-width:auto;}
  .action-buttons{flex-direction:column;}
  .btn{width:100%;justify-content:center;font-size:15px;padding:14px 20px;}
  table{font-size:12px;min-width:800px;}
  th,td{padding:12px 8px;}
}
@media print{
  body{background:white;padding:0;}
  .card{box-shadow:none;border:none;}
  .header-buttons,.filter-section{display:none;}
  table{page-break-inside:auto;}
  tr{page-break-inside:avoid;page-break-after:auto;}
  thead{display:table-header-group;}
}
</style>
</head>

<body onload="initReport()">
<div class="card">
  <div class="header-container">
    <div class="header-left">
      <h1>Attendance Report</h1>
      <div id="welcome" class="small"></div>
    </div>
    <div class="header-buttons">
      <button class="btn" onclick="window.location.href='coe.html'">üßæ Dashboard</button>
      <button class="btn" onclick="window.location.href='lock.html'">üîí Lock</button>
      <button class="btn" onclick="window.location.href='upload.html'">‚è´ Upload</button>
      <button class="btn btn-secondary" onclick="logout()">üñ≤Ô∏è Logout</button>
    </div>
  </div>

  <div class="divider"></div>

  <div class="filter-section">
    <div class="filter-header">Filter Options</div>
    <div class="filter-bar">
      <select id="filterType" onchange="onFilterChange()">
        <option value="Overall">üìä Overall</option>
        <option value="Department">üè¢ Department</option>
        <option value="Hall">üèõÔ∏è Hall</option>
        <option value="Date">üìÖ Date</option>
      </select>
      <select id="filterValue" style="display:none"></select>
      <input type="date" id="filterDate" style="display:none" />
      <select id="filterBatch" style="display:none;">
        <option value="">Select Batch</option>
        <option value="FN">FN - Forenoon</option>
        <option value="AN">AN - Afternoon</option>
      </select>
    </div>
    <div class="action-buttons">
      <button class="btn btn-load" onclick="loadReport()">üîç Load Report</button>
      <button class="btn btn-csv"  onclick="downloadCSV()">üìâ Download CSV</button>
      <button class="btn btn-pdf"  onclick="downloadPDF()">üìë Download PDF</button>
    </div>
  </div>

  <div id="reportTable"></div>
</div>

<script>
let user=null, allData=[], lastReport=[], selectedBatch='';

async function initReport(){
  user=requireRole('CoE');
  if(!user) return;
  document.getElementById('welcome').innerText=`Signed in as: ${user.name}`;
  const res=await apiFetch({action:'report'});
  if(!res.success){alert("Failed to load data");return;}
  allData=res.rows||[];
  populateFilters();
}

function populateFilters(){
  const depts=[...new Set(allData.map(r=>r.Department).filter(Boolean))].sort();
  const halls=[...new Set(allData.map(r=>r.HallNo).filter(Boolean))].sort();
  const sel=document.getElementById('filterValue');
  sel.innerHTML='';
  depts.forEach(d=>{const op=document.createElement('option');op.value=d;op.text=d;op.dataset.type='Department';sel.appendChild(op);});
  halls.forEach(h=>{const op=document.createElement('option');op.value=h;op.text=h;op.dataset.type='Hall';sel.appendChild(op);});
}

function onFilterChange(){
  const type=document.getElementById('filterType').value;
  const valSel=document.getElementById('filterValue');
  const dateSel=document.getElementById('filterDate');
  const batchSel=document.getElementById('filterBatch');
  if(type==='Overall'){valSel.style.display='none';dateSel.style.display='none';batchSel.style.display='none';}
  else if(type==='Date'){valSel.style.display='none';dateSel.style.display='inline-block';batchSel.style.display='inline-block';}
  else{
    valSel.style.display='inline-block';dateSel.style.display='none';batchSel.style.display='none';
    [...valSel.options].forEach(op=>op.hidden=op.dataset.type!==type);
    const first=[...valSel.options].find(op=>!op.hidden);
    if(first) valSel.value=first.value;
  }
}

async function loadReport(){
  const type=document.getElementById('filterType').value;
  const val=document.getElementById('filterValue').value;
  const dateVal=document.getElementById('filterDate').value;
  const batchVal=document.getElementById('filterBatch').value;
  selectedBatch=batchVal;
  let filtered=[...allData];
  if(type==='Department') filtered=filtered.filter(r=>r.Department===val);
  if(type==='Hall')        filtered=filtered.filter(r=>r.HallNo===val);
  if(type==='Date'&&dateVal) filtered=filtered.filter(r=>r.Date===dateVal);
  if(batchVal) filtered=filtered.filter(r=>((r.Batch||'').trim().toUpperCase())===batchVal.toUpperCase());
  lastReport=filtered.filter(r=>{const st=(r.Status||'').trim().toUpperCase();return st==='ABSENT'||st==='OD';});
  renderReportTable();
}

function renderReportTable(){
  const container=document.getElementById('reportTable');
  const headers=["Date","Batch","RollNo","Name","Department","Year","Section","HallNo","SeatNo","SubjectCode","Subject","Status","Reason"];
  if(lastReport.length===0){container.innerHTML='<div class="empty-state fade-in"><p>No records found. Try adjusting your filters.</p></div>';return;}
  let html='<div class="table-container fade-in"><table><thead><tr>';
  headers.forEach(h=>html+=`<th>${h}</th>`);
  html+='</tr></thead><tbody>';
  lastReport.forEach(r=>{
    html+=`<tr>
      <td>${r.Date||''}</td><td>${r.Batch||''}</td><td>${r.RollNo}</td><td>${r.Name}</td>
      <td>${r.Department}</td><td>${r.Year}</td><td>${r.Section}</td><td>${r.HallNo}</td>
      <td>${r.SeatNo}</td><td>${r.SubjectCode}</td><td>${r.Subject}</td><td>${r.Status}</td><td>${r.Reason}</td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  container.innerHTML=html;
}

function downloadCSV(){
  if(!lastReport.length) return alert('No data to download');
  const headers=["Date","Batch","RollNo","Name","Department","Year","Section","HallNo","SeatNo","SubjectCode","Subject","Status","Reason"];
  const rows=lastReport.map(r=>[r.Date,r.Batch||selectedBatch||'',r.RollNo,r.Name,r.Department,r.Year,r.Section,r.HallNo,r.SeatNo,r.SubjectCode,r.Subject,r.Status,r.Reason]);
  const csv=[headers.join(","),...rows.map(r=>r.map(s=>`"${s}"`).join(","))].join("\n");
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`absentees_OD_${document.getElementById('filterDate').value||'All'}_${selectedBatch||'All'}.csv`;
  a.click();URL.revokeObjectURL(url);
}

/* ================================================================
   LOGO LOADER ‚Äî tries multiple filenames gracefully
================================================================ */
async function loadLogoForPDF(){
  const paths=["logo.jpeg","logo.jpg","logo.png","./logo.jpeg","./logo.jpg","./logo.png"];
  for(const src of paths){
    try{
      const r=await fetch(src,{cache:"no-cache"});
      if(!r.ok) continue;
      const blob=await r.blob();
      const bmp=await createImageBitmap(blob);
      const cv=document.createElement("canvas");
      cv.width=bmp.width; cv.height=bmp.height;
      cv.getContext("2d").drawImage(bmp,0,0);
      const fmt=src.endsWith(".png")?"PNG":"JPEG";
      return {data:cv.toDataURL(src.endsWith(".png")?"image/png":"image/jpeg"),fmt,w:bmp.width,h:bmp.height};
    }catch(e){/* try next */}
  }
  return null;
}

/* ================================================================
   PROFESSIONAL INSTITUTIONAL PDF REPORT
================================================================ */
async function downloadPDF(){
  if(!lastReport.length) return alert('No data to download');

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF("landscape","pt","a4");
  const PW=doc.internal.pageSize.getWidth();   // 841.89
  const PH=doc.internal.pageSize.getHeight();  // 595.28
  const ML=36, MR=36, CW=PW-ML-MR;
  const genTime=new Date().toLocaleString('en-IN');

  /* ---- filter meta ---- */
  const filterType=document.getElementById('filterType').value;
  const filterVal =document.getElementById('filterValue').value;
  const dateVal   =document.getElementById('filterDate').value||'';
  const batchVal  =selectedBatch||'';

  let displayDate=dateVal;
  if(dateVal){
    const d=new Date(dateVal);
    displayDate=`${d.getDate().toString().padStart(2,'0')}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getFullYear()}`;
  }

  const deptMap={
    "CSE":"COMPUTER SCIENCE AND ENGINEERING",
    "ECE":"ELECTRONICS AND COMMUNICATION ENGINEERING",
    "ME":"MECHANICAL ENGINEERING",
    "CE":"CIVIL ENGINEERING",
    "ADS":"ARTIFICIAL INTELLIGENCE AND DATA SCIENCE"
  };

  const absentCount=lastReport.filter(r=>(r.Status||'').toUpperCase()==='ABSENT').length;
  const odCount    =lastReport.filter(r=>(r.Status||'').toUpperCase()==='OD').length;

  /* ---- logo ---- */
  const logo=await loadLogoForPDF();

  /* ================================================================
     PAGE 1 FULL HEADER
  ================================================================ */
  function drawPage1Header(){
    let y=14;

    /* Logo ‚Äî centred */
    if(logo){
      const maxW=240, maxH=60, ratio=logo.w/logo.h;
      let lw=maxW, lh=maxW/ratio;
      if(lh>maxH){lh=maxH;lw=maxH*ratio;}
      doc.addImage(logo.data,logo.fmt,(PW-lw)/2,y,lw,lh);
      y+=lh+5;
    }

    /* Institution / CoE name */
    doc.setFont("times","bold"); doc.setFontSize(12); doc.setTextColor(0);
    doc.text("Office of the Controller of Examinations",PW/2,y,{align:"center"}); y+=13;
    doc.setFont("times","normal"); doc.setFontSize(10);
    doc.text("ODD Semester ‚Äì Academic Year 2025‚Äì2026",PW/2,y,{align:"center"}); y+=8;

    /* Double top border */
    doc.setDrawColor(0); doc.setLineWidth(1.5); doc.line(ML,y,PW-MR,y); y+=2;
    doc.setLineWidth(0.5);                       doc.line(ML,y,PW-MR,y); y+=2;

    /* Solid black title bar */
    doc.setFillColor(0); doc.rect(ML,y,CW,22,"F");
    doc.setFont("times","bold"); doc.setFontSize(13); doc.setTextColor(255);
    doc.text("ATTENDANCE REPORT ‚Äì ABSENTEES & ON DUTY",PW/2,y+15,{align:"center"}); y+=22;

    /* Double bottom border */
    doc.setTextColor(0); doc.setDrawColor(0);
    doc.setLineWidth(0.5); doc.line(ML,y,PW-MR,y); y+=2;
    doc.setLineWidth(1.5); doc.line(ML,y,PW-MR,y); y+=7;

    /* ---- Info block: 3√ó2 bordered table ---- */
    const filterLabel=
      filterType==='Overall'   ? 'All Departments' :
      filterType==='Department'? (deptMap[filterVal]||filterVal) :
      filterType==='Hall'      ? 'Hall No: '+filterVal :
      filterType==='Date'      ? 'Date Wise' : '‚Äî';

    const infoRows=[
      ["Examination Date",   displayDate||"All Dates",   "Session / Batch",  batchVal||"All"],
      ["Filter Applied",     filterLabel,                "Academic Year",    "ODD Sem ‚Äì 2025‚Äì2026"],
      ["Total Records",      String(lastReport.length),  "Absent / On Duty", absentCount+" Absent  |  "+odCount+" On Duty"],
    ];

    const iLblW=80, iValW=CW/2-iLblW-4, iRowH=15, iTotalH=infoRows.length*iRowH;
    const c2X=ML+CW/2+4;

    doc.setLineWidth(0.6); doc.setDrawColor(0);
    doc.rect(ML,y,CW,iTotalH,"D");
    doc.line(ML+CW/2,y,ML+CW/2,y+iTotalH);
    doc.line(ML+iLblW,y,ML+iLblW,y+iTotalH);
    doc.line(c2X+iLblW,y,c2X+iLblW,y+iTotalH);

    infoRows.forEach((row,ri)=>{
      const ry=y+ri*iRowH;
      if(ri>0){doc.setLineWidth(0.3);doc.line(ML,ry,ML+CW,ry);}

      /* shade label cells */
      doc.setFillColor(235,235,235);
      doc.rect(ML,ry,iLblW,iRowH,"F");
      doc.rect(c2X,ry,iLblW,iRowH,"F");

      doc.setFont("times","bold"); doc.setFontSize(8.5); doc.setTextColor(0);
      doc.text(row[0],ML+3,ry+10);
      doc.text(row[2],c2X+3,ry+10);
      doc.setFont("times","normal");
      doc.text(doc.splitTextToSize(row[1],iValW-4)[0],ML+iLblW+3,ry+10);
      doc.text(doc.splitTextToSize(row[3],iValW-4)[0],c2X+iLblW+3,ry+10);
    });

    y+=iTotalH+8;
    return y;
  }

  /* ================================================================
     CONTINUATION HEADER (compact, pages 2+)
  ================================================================ */
  function drawContHeader(){
    let y=10;
    if(logo){
      const maxW=180, maxH=42, ratio=logo.w/logo.h;
      let lw=maxW, lh=maxW/ratio;
      if(lh>maxH){lh=maxH;lw=maxH*ratio;}
      doc.addImage(logo.data,logo.fmt,(PW-lw)/2,y,lw,lh);
      y+=lh+4;
    }
    doc.setFont("times","bold"); doc.setFontSize(9); doc.setTextColor(0);
    doc.text("Office of the Controller of Examinations",PW/2,y,{align:"center"}); y+=9;

    doc.setFillColor(0); doc.rect(ML,y,CW,16,"F");
    doc.setFont("times","bold"); doc.setFontSize(9); doc.setTextColor(255);
    doc.text("ATTENDANCE REPORT ‚Äì ABSENTEES & ON DUTY  (contd.)",PW/2,y+11,{align:"center"}); y+=16;

    doc.setTextColor(0); doc.setDrawColor(0); doc.setLineWidth(1.0); doc.line(ML,y,PW-MR,y); y+=5;
    return y;
  }

  /* ================================================================
     FOOTER
  ================================================================ */
  function drawFooter(pageNum,totalPg){
    doc.setLineWidth(0.5); doc.setDrawColor(0); doc.line(ML,PH-18,PW-MR,PH-18);
    doc.setFont("times","normal"); doc.setFontSize(7.5); doc.setTextColor(0);
    doc.text("Generated: "+genTime,ML,PH-8);
    doc.text("Total: "+lastReport.length+" | Absent: "+absentCount+" | OD: "+odCount,PW/2,PH-8,{align:"center"});
    doc.text("Page "+pageNum+" of "+totalPg,PW-MR,PH-8,{align:"right"});
  }

  /* ================================================================
     COLUMN DEFINITIONS
  ================================================================ */
  const cols=[
    {hdr:"S.No",       key:null,          w:24, align:"center", sno:true},
    {hdr:"Date",       key:"Date",        w:52, align:"center"},
    {hdr:"Batch",      key:"Batch",       w:28, align:"center"},
    {hdr:"Roll No",    key:"RollNo",      w:66, align:"center", bold:true},
    {hdr:"Student Name",key:"Name",       w:115,align:"left"},
    {hdr:"Dept",       key:"Department",  w:36, align:"center"},
    {hdr:"Year",       key:"Year",        w:26, align:"center"},
    {hdr:"Sec",        key:"Section",     w:22, align:"center"},
    {hdr:"Hall",       key:"HallNo",      w:35, align:"center"},
    {hdr:"Seat",       key:"SeatNo",      w:30, align:"center"},
    {hdr:"Sub Code",   key:"SubjectCode", w:54, align:"center"},
    {hdr:"Subject",    key:"Subject",     w:100,align:"left"},
    {hdr:"Status",     key:"Status",      w:40, align:"center", bold:true},
    {hdr:"Reason",     key:"Reason",      w:82, align:"left"},
  ];

  /* scale widths to fill CW */
  const rawSum=cols.reduce((s,c)=>s+c.w,0);
  const sf=CW/rawSum;
  cols.forEach(c=>c.sw=c.w*sf);

  const HDR_H=20, ROW_H=17;

  /* ---- draw table header row ---- */
  function drawTableHeader(y){
    doc.setFillColor(0); doc.rect(ML,y,CW,HDR_H,"F");
    doc.setFont("times","bold"); doc.setFontSize(8); doc.setTextColor(255);
    let x=ML;
    cols.forEach((c,i)=>{
      if(i>0){doc.setDrawColor(70);doc.setLineWidth(0.4);doc.line(x,y,x,y+HDR_H);}
      doc.text(c.hdr,x+c.sw/2,y+13,{align:"center",maxWidth:c.sw-3});
      x+=c.sw;
    });
    doc.setDrawColor(0); doc.setLineWidth(0.8); doc.rect(ML,y,CW,HDR_H,"S");
    return y+HDR_H;
  }

  /* ================================================================
     BUILD PDF
  ================================================================ */
  let y=drawPage1Header(doc,14);
  y=drawTableHeader(y);

  lastReport.forEach((row,ri)=>{
    /* page break */
    if(y+ROW_H>PH-26){
      doc.addPage();
      y=drawContHeader();
      y=drawTableHeader(y);
    }

    /* row background */
    const st=(row.Status||'').toUpperCase();
    if(ri%2===0) doc.setFillColor(248,248,248); else doc.setFillColor(255,255,255);
    doc.rect(ML,y,CW,ROW_H,"F");

    /* cells */
    let x=ML;
    doc.setFontSize(8.5); doc.setTextColor(0);
    cols.forEach((c,ci)=>{
      /* vertical separator */
      if(ci>0){doc.setDrawColor(200);doc.setLineWidth(0.3);doc.line(x,y,x,y+ROW_H);}

      let val=c.sno ? String(ri+1) : String(row[c.key]||'');
      if(c.key==='Status') val=val.toUpperCase();

      /* truncate */
      const mw=c.sw-5;
      while(doc.getTextWidth(val)>mw&&val.length>1) val=val.slice(0,-1);
      if(val.length<String(c.sno?ri+1:row[c.key]||'').length&&val.length>3) val=val.slice(0,-2)+'..';

      if(c.bold) doc.setFont("times","bold"); else doc.setFont("times","normal");
      const ty=y+ROW_H/2+3;
      if(c.align==='left') doc.text(val,x+4,ty);
      else                  doc.text(val,x+c.sw/2,ty,{align:"center"});
      x+=c.sw;
    });

    /* row border */
    doc.setDrawColor(210); doc.setLineWidth(0.3); doc.rect(ML,y,CW,ROW_H,"S");
    y+=ROW_H;
  });

  /* ================================================================
     SECTION-WISE SUMMARY TABLE
  ================================================================ */
  if(y+80>PH-26){doc.addPage();y=drawContHeader();}
  y+=10;

  const secMap={};
  lastReport.forEach(r=>{
    const k=`Year ${r.Year||'?'} ‚Äì Sec ${r.Section||'?'} (${r.Department||'?'})`;
    if(!secMap[k]) secMap[k]={absent:0,od:0};
    const st=(r.Status||'').toUpperCase();
    if(st==='ABSENT') secMap[k].absent++; else if(st==='OD') secMap[k].od++;
  });
  const sumRows=Object.keys(secMap).sort().map(k=>[k,secMap[k].absent,secMap[k].od,secMap[k].absent+secMap[k].od]);
  sumRows.push(["TOTAL",absentCount,odCount,lastReport.length]);

  doc.setFont("times","bold"); doc.setFontSize(10); doc.setTextColor(0);
  doc.text("SUMMARY BY YEAR / SECTION",ML,y); y+=5;

  doc.autoTable({
    head:[["Year / Section","Absent","On Duty","Total"]],
    body:sumRows,
    startY:y,
    theme:"grid",
    headStyles:{fillColor:[0,0,0],textColor:[255,255,255],fontStyle:"bold",fontSize:9,halign:"center",lineColor:[0,0,0],lineWidth:0.6,cellPadding:4},
    columnStyles:{
      0:{halign:"left",fontStyle:"bold",cellWidth:220},
      1:{halign:"center",cellWidth:65},
      2:{halign:"center",cellWidth:65},
      3:{halign:"center",cellWidth:65,fontStyle:"bold"}
    },
    bodyStyles:{font:"times",fontSize:9.5,cellPadding:4,textColor:[0,0,0],lineColor:[0,0,0],lineWidth:0.5},
    alternateRowStyles:{fillColor:[245,245,245]},
    didParseCell:function(d){
      if(d.row.index===sumRows.length-1){d.cell.styles.fontStyle="bold";d.cell.styles.fillColor=[220,220,220];}
    },
    margin:{left:ML,right:MR+CW-415}
  });

  y=doc.lastAutoTable.finalY+14;

  /* ================================================================
     SIGNATURE BLOCK
  ================================================================ */
  const sigNeed=65;
  if(y<PH-sigNeed-28) y=PH-sigNeed-28;
  if(y>PH-40){doc.addPage();y=PH-sigNeed-28;}

  doc.setDrawColor(0); doc.setLineWidth(1.2); doc.line(ML,y,PW-MR,y); y+=2;
  doc.setLineWidth(0.4);                       doc.line(ML,y,PW-MR,y); y+=10;

  const sigs=[
    {label:"Prepared By",                x:ML},
    {label:"Controller of Examinations", x:PW/2-70},
    {label:"Head of Institution",        x:PW-MR-140},
  ];
  const sigY=y+28;
  sigs.forEach(s=>{
    doc.setLineWidth(0.8); doc.setDrawColor(0); doc.line(s.x,sigY,s.x+130,sigY);
    doc.setFont("times","bold"); doc.setFontSize(9); doc.setTextColor(0);
    doc.text(s.label,s.x+65,sigY+13,{align:"center"});
  });

  /* ================================================================
     PAGE FOOTERS ON ALL PAGES
  ================================================================ */
  const totalPg=doc.getNumberOfPages();
  for(let p=1;p<=totalPg;p++){doc.setPage(p);drawFooter(p,totalPg);}

  /* ---- save ---- */
  const safeDate=(dateVal||new Date().toISOString().split('T')[0]).replace(/-/g,'');
  const safeBatch=(selectedBatch||'All').replace(/[^a-z0-9]/gi,'_');
  doc.save(`AttendanceReport_${safeDate}_${safeBatch}.pdf`);
}

function logout(){localStorage.removeItem("user");location.href="index.html";}
</script>
</body>
</html>
