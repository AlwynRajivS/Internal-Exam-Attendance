<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Staff Dashboard - Hall Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
  <style>
    /* -------------------- GLOBAL DESIGN -------------------- */
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: linear-gradient(135deg, #fdfdfd 0%, #f2f4f8 40%, #e9edf3 100%);
      min-height: 100vh;
      color: #222;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    h1 {
      color: #1a237e;
      margin: 0;
    }

    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 16px 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 14px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      backdrop-filter: blur(8px);
    }

    /* -------------------- BUTTONS -------------------- */
    .btn {
      background: linear-gradient(90deg, #2563eb, #3b82f6);
      color: #fff;
      padding: 9px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      font-weight: 500;
    }

    .btn:hover {
      background: linear-gradient(90deg, #1e40af, #2563eb);
      transform: scale(1.03);
      box-shadow: 0 3px 10px rgba(37, 99, 235, 0.3);
    }

    /* -------------------- GRID & INPUT -------------------- */
    .u-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="date"], select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f9fafb;
      min-width: 120px;
      flex: 1;
    }

    .small {
      font-size: 13px;
      color: #555;
    }

    /* -------------------- HALL GRID -------------------- */
    .hall-grid {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: flex-start;
      margin-top: 16px;
    }

    .column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 90px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(248, 250, 255, 0.7);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transition: 0.2s ease;
    }

    .column:hover {
      transform: translateY(-2px);
      background: rgba(240, 245, 255, 0.9);
    }

    .col-label {
      font-weight: bold;
      color: #333;
      background: #e0e7ff;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .seat {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      margin: 4px;
      font-size: 13px;
      white-space: pre-line;
      width: 80px;
      transition: 0.2s ease-in-out;
    }

    .present {
      background: #dcfce7;
      border: 1px solid #16a34a;
      color: #064e3b;
    }

    .absent {
      background: #fee2e2;
      border: 1px solid #dc2626;
      color: #7f1d1d;
    }

    .od {
      background: #ede9fe;
      border: 1px solid #7c3aed;
      color: #4c1d95;
    }

    .seat:hover {
      transform: scale(1.05);
    }

    .locked .seat {
      pointer-events: none;
      opacity: 0.6;
    }

    /* -------------------- RESPONSIVE DESIGN -------------------- */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .card {
        padding: 16px;
        margin: 8px;
      }

      h1 {
        font-size: 20px;
      }

      .u-row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        text-align: center;
      }

      .hall-grid {
        justify-content: center;
      }

      .column {
        min-width: 70px;
      }
    }
  </style>
</head>
<body onload="initStaff()">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
      <div>
        <h1>Staff Dashboard</h1>
        <div id="welcome" class="small"></div>
      </div>
      <div><button class="btn" onclick="logout()">Logout</button></div>
    </div>
    <hr>
    <section>
      <div class="u-row" style="margin-bottom:8px">
        <label>Date:</label>
        <input type="date" id="dateFilter" />

        <label>Batch:</label>
        <select id="batchSelect">
          <option value="FN">FN</option>
          <option value="AN">AN</option>
        </select>

        <label>Hall:</label>
        <select id="hallSelect"></select>

        <button class="btn" onclick="loadHall()">Load Hall</button>
        <button class="btn" id="saveBtn" onclick="saveAttendance()" disabled>Save</button>
      </div>
      <div id="hallGrid"></div>
      <div id="statusMsg" class="small" style="margin-top:10px"></div>
    </section>
  </div>

  <script>
    /* ⚙️ Your Original JavaScript (Unchanged) */
    let user = null;
    let hallData = [];

    function initStaff(){
      user = requireRole('Staff');
      if(!user) return;
      document.getElementById('welcome').innerText = `Signed in as: ${user.name} — Dept: ${user.department}`;
      populateHalls();
    }

    async function populateHalls() {
      const res = await apiFetch({ action: "getHalls", department: user.department });
      const sel = document.getElementById('hallSelect');
      sel.innerHTML = '';

      if (!res.success) {
        sel.innerHTML = '<option>Error loading halls</option>';
        return;
      }

      const halls = res.halls || [];
      if (halls.length === 0) {
        sel.innerHTML = '<option>No halls</option>';
        return;
      }

      halls.forEach(h => {
        const op = document.createElement('option');
        op.value = h;
        op.textContent = h;
        sel.appendChild(op);
      });
    }

    let isLocked = false; 

    async function checkLockStatus(date) {
      if (!date) return;
      const batch = document.getElementById("batchSelect").value || "";
      const res = await apiFetch({ action: "getLockStatus", date, batch });
      const grid = document.getElementById("hallGrid");
      const saveBtn = document.getElementById("saveBtn");

      if (res.lock === "Locked") {
        isLocked = true;
        document.getElementById("statusMsg").textContent = `Editing locked by CoE for ${date}`;
        grid.classList.add("locked");
        saveBtn.disabled = true;
      } else {
        isLocked = false;
        document.getElementById("statusMsg").textContent = "";
        grid.classList.remove("locked");
        saveBtn.disabled = false;
      }
    }

    async function loadHall() {
      const hallNo = document.getElementById("hallSelect").value;
      const date = document.getElementById("dateFilter").value || "";
      const batch = document.getElementById("batchSelect").value || "";

      if (!hallNo) {
        alert("Select hall");
        return;
      }
      document.getElementById("hallGrid").innerHTML = '<div class="small">Loading...</div>';

      await checkLockStatus(date);

      const res = await apiFetch({ action: "getHall", department: user.department, hallNo, date, batch });

      if (!res.success) {
        document.getElementById("hallGrid").innerHTML = "Error: " + (res.message || "");
        return;
      }

      hallData = res.hallData || [];
      renderHall();

      if (isLocked) {
        document.getElementById("hallGrid").classList.add("locked");
        document.getElementById("saveBtn").disabled = true;
      }
    }

    function renderHall(){
      const container = document.getElementById('hallGrid');
      if(!hallData.length){
        container.innerHTML = '<div class="small">No seating data</div>';
        document.getElementById('saveBtn').disabled=true;
        return;
      }

      const grouped = {};
      hallData.forEach((r, idx) => {
        const prefix = (r.SeatNo || '').trim().charAt(0).toUpperCase() || '?';
        if(!grouped[prefix]) grouped[prefix] = [];
        grouped[prefix].push({...r, index: idx});
      });

      const sortedPrefixes = Object.keys(grouped).sort();
      const grid = document.createElement('div');
      grid.className = 'hall-grid';

      sortedPrefixes.forEach(pref => {
        const col = document.createElement('div');
        col.className = 'column';
        const label = document.createElement('div');
        label.className = 'col-label';
        label.textContent = pref;
        col.appendChild(label);

        grouped[pref].sort((a,b)=>{
          const na = parseInt(a.SeatNo.substring(1)) || 0;
          const nb = parseInt(b.SeatNo.substring(1)) || 0;
          return na - nb;
        }).forEach(r=>{
          const div = document.createElement('div');
          div.className = 'seat ' + (r.Status==='Absent'?'absent': r.Status==='OD' ? 'od' : 'present');
          div.textContent = r.SeatNo + '\n' + (r.RollNo || '');
          div.title = `${r.RollNo} - ${r.Name || ''} (${r.Year||''} ${r.Section||''})`;
          div.addEventListener('click', e => singleOrDouble(e, ()=> setAbsent(r.index,div)));
          div.addEventListener('dblclick', e => { e.preventDefault(); setOD(r.index,div); });
          col.appendChild(div);
        });
        grid.appendChild(col);
      });

      container.innerHTML = '';
      container.appendChild(grid);
      document.getElementById('saveBtn').disabled=false;
    }

    let clickTimer = null;
    function singleOrDouble(e, singleFn){
      if (clickTimer !== null) {
        clearTimeout(clickTimer);
        clickTimer = null;
        return;
      }
      clickTimer = setTimeout(()=>{ singleFn(); clickTimer = null; }, 250);
    }

    function setAbsent(idx, div){
      hallData[idx].Status = hallData[idx].Status === 'Absent' ? 'Present' : 'Absent';
      div.className = 'seat ' + (hallData[idx].Status==='Absent' ? 'absent' : 'present');
    }

    function setOD(idx, div){
      hallData[idx].Status = hallData[idx].Status === 'OD' ? 'Present' : 'OD';
      div.className = 'seat ' + (hallData[idx].Status==='OD' ? 'od' : (hallData[idx].Status==='Absent'?'absent':'present'));
    }

    async function saveAttendance() {
      const hallNo = document.getElementById('hallSelect').value;
      const date = document.getElementById('dateFilter').value || '';
      const batch = document.getElementById("batchSelect").value || "";

      if (!hallNo || !date) { alert('Select hall and date'); return; }

      const resLock = await apiFetch({ action: 'checkLock', date });
      if (resLock.locked) {
        alert(`Attendance for ${date} is locked by CoE.`);
        return;
      }

      const updates = hallData.map(r => ({ RollNo: r.RollNo, Status: r.Status }));
      const res = await apiFetch({ action:'saveAttendance', hallNo, date, batch, updates });
      const msg = document.getElementById('statusMsg');
      msg.textContent = res.success ? 'Saved successfully' : `Save failed: ${res.message || ''}`;
    }

    function logout() {
      localStorage.removeItem("user");
      location.href = "index.html";
    }
  </script>
</body>
</html>
